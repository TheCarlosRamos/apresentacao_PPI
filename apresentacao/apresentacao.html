<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Acompanhamento de Projetos - PPI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: The SPA uses a dashboard-style, single-page layout with a fixed sidebar for sector navigation (Portos, Rodovias, Ferrovias, etc.). The main content area initially displays a high-level summary with key metrics across all projects and a chart showing project distribution by sector. Clicking a sector in the sidebar or on the chart dynamically filters and displays a grid of project summary cards for that sector. Each card shows the project name and its current status (visualized with a color-coded indicator). Clicking a card opens a modal window, revealing detailed information: a comprehensive description, a visual timeline of key milestones (Estudos, Leilão, Contrato), current status, next steps, and critical "Pontos de Atenção" (risks). This drill-down architecture was chosen to manage the high information density of the report, allowing users to move from a broad overview to specific project details in an intuitive, hierarchical manner, rather than being confronted with a long, unstructured scroll of text. This promotes exploration and makes complex project tracking more digestible. -->
    <!-- Visualization & Content Choices: 
- Report Info: Overall project portfolio status. Goal: Inform. Viz/Method: KPI cards (HTML/Tailwind) and a main Bar Chart (Chart.js) showing project counts per sector. Interaction: Clicking a sector on the chart or sidebar filters the project list. Justification: Provides an immediate high-level overview and entry point for exploration.
- Report Info: List of projects within each sector. Goal: Organize/Navigate. Viz/Method: A dynamic grid of project cards (HTML/Tailwind). Each card has a color-coded status indicator. Interaction: Filtering via search bar; clicking a card reveals details. Justification: Allows users to quickly scan projects and dive into specifics.
- Report Info: Project milestones and deadlines (EVTEA, AP, TCU, Edital, Leilão). Goal: Show Change/Process. Viz/Method: A horizontal timeline component built with HTML/CSS and Unicode icons (✅, ⏳). Interaction: Static visual for clarity. Justification: Visually represents the project lifecycle more effectively than a simple text list.
- Report Info: Physical progress percentages (e.g., FIOL railway). Goal: Inform. Viz/Method: HTML/CSS progress bars. Interaction: Static display. Justification: A standard and instantly understandable way to show completion.
- Report Info: "Pontos de Atenção" (risks). Goal: Alert/Inform. Viz/Method: A styled callout box with a warning icon. Interaction: Static text. Justification: Visually separates critical risk information from general status updates.
- Report Info: Financial data (Leilão results, investments). Goal: Inform. Viz/Method: Formatted text in KPI cards within the project detail view. Justification: Clear and direct presentation for key numbers. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --primary: #2E4E8C; /* azul PPI */
            --primary-dark: #243B6B;
            --primary-light: #3E5FA4;
            --accent-green: #2E7D32;
            --accent-yellow: #F7B500;
            --accent-red: #C62828;
        }

        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: #4A4A4A;
            font-family: 'Inter', sans-serif;
        }
        /* Títulos sobre o fundo azul */
        #section-title { color: #FFFFFF; }
        #section-subtitle { color: #E5E7EB; }

        /* Harmonização dos utilitários mais usados com a paleta */
        .text-blue-500 { color: var(--primary) !important; }
        .text-blue-700 { color: var(--primary-dark) !important; }
        .bg-blue-100 { background-color: rgba(46, 78, 140, 0.12) !important; }
        .text-green-500 { color: var(--accent-green) !important; }
        .bg-green-100 { background-color: rgba(46, 125, 50, 0.12) !important; }
        .text-yellow-500 { color: var(--accent-yellow) !important; }
        .bg-yellow-100 { background-color: rgba(247, 181, 0, 0.12) !important; }

        /* Pontos de status alinhados à paleta */
        .status-dot.bg-blue-500 { background-color: var(--primary) !important; }
        .status-dot.bg-green-500 { background-color: var(--accent-green) !important; }
        .status-dot.bg-yellow-500 { background-color: var(--accent-yellow) !important; }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        /* Phase Timeline Styles */
        .phase-timeline {
            position: relative;
            margin: 2rem 0;
            padding: 0 1rem;
        }

        .phase-timeline--compact {
            margin: 1rem 0;
        }

        .phase-line {
            position: absolute;
            top: 16px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
        }

        .phase-line-completed {
            position: absolute;
            top: 16px;
            left: 0;
            height: 4px;
            background-color: #10B981;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .phase-items {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .phase-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-width: 100px;
        }

        .phase-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #e5e7eb;
            border: 3px solid white;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .phase-dot.completed {
            background-color: #10B981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .phase-dot.current {
            background-color: #3B82F6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            transform: scale(1.2);
        }

        .phase-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            text-align: center;
            color: #6B7280;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .phase-label.completed {
            color: #10B981;
            font-weight: 600;
        }

        .phase-label.current {
            color: #3B82F6;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .phase-item {
                min-width: 60px;
            }
            
            .phase-label {
                font-size: 0.65rem;
            }
        }

        @media (max-width: 480px) {
            .phase-item {
                min-width: 40px;
            }
            
            .phase-label {
                font-size: 0.6rem;
                white-space: nowrap;
                transform: rotate(-45deg);
                transform-origin: top left;
                position: absolute;
                bottom: -30px;
                left: 50%;
                margin-left: -10px;
                width: 80px;
                text-align: left;
            }
        }
        
        /* Estilos para a tabela de projetos */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .projects-table-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .projects-table {
            min-width: 100%;
            table-layout: fixed;
        }
        
        .projects-table th,
        .projects-table td {
            vertical-align: top;
            padding: 0.75rem 1rem;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            display: -moz-box;
            -moz-line-clamp: 2;
            -moz-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 2.5em;
            line-height: 1.25em;
        }
        
        /* Estilos para a tabela de projetos */
        .projects-table-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .projects-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        
        .projects-table th,
        .projects-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .projects-table th {
            background-color: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #6b7280;
        }
        
        .projects-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .projects-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        
        .projects-table th,
        .projects-table td {
            vertical-align: middle;
            padding: 1rem 1.5rem;
        }
        
        /* Ajustes para dispositivos móveis */
        @media (max-width: 768px) {
            .projects-table th,
            .projects-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .projects-table th:first-child,
            .projects-table td:first-child {
                padding-left: 1rem;
            }
            
            .projects-table th:last-child,
            .projects-table td:last-child {
                padding-right: 1rem;
            }
        }
        
        /* Ajustes para barras de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 1.25rem;
            bottom: -1.25rem;
            width: 2px;
            background-color: #D1D5DB;
            transform: translateX(-50%);
        }
        .timeline-item:first-child::before {
             top: 1.25rem;
             bottom: unset;
             height: calc(100% - 1.25rem);
        }
         .timeline-item:last-child::before {
             display: none;
        }
        .timeline-icon {
            z-index: 10;
        }
        /* Linha do tempo por fases (Estudos -> Assinatura) */
        .phase-timeline { 
            position: relative; 
            padding: 1rem 0;
        }
        .phase-line { 
            position: absolute; 
            top: 1.25rem; 
            left: 0.75rem; 
            right: 0.75rem; 
            height: 3px; 
            background: #E5E7EB;
            z-index: 1;
        }
        .phase-line-completed {
            background: #10B981;
            position: absolute;
            top: 1.25rem;
            left: 0.75rem;
            height: 3px;
            z-index: 2;
            transition: width 0.3s ease;
        }
        .phase-items { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            align-items: start; 
            gap: 0;
            position: relative;
            z-index: 3;
        }
        .phase-item { 
            text-align: center; 
            position: relative; 
        }
        .phase-dot { 
            width: 22px; 
            height: 22px; 
            border-radius: 9999px; 
            background: #FFFFFF; 
            border: 3px solid #9CA3AF; 
            margin: 0 auto; 
            position: relative;
            z-index: 4;
            transition: all 0.3s ease;
        }
        .phase-dot.completed { 
            background: #10B981; 
            border-color: #10B981; 
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }
        .phase-label { 
            margin-top: 0.5rem; 
            font-size: 0.75rem; 
            color: #4B5563;
            font-weight: 500;
        }
        .phase-label.completed {
            color: #10B981;
            font-weight: 600;
        }
        .phase-meta { 
            margin-top: 0.25rem; 
            font-size: 0.7rem; 
            color: #6B7280; 
        }
        /* Variante compacta para cards da lista */
        .phase-timeline--compact .phase-line { 
            top: 0.9rem; 
            height: 2px; 
        }
        .phase-timeline--compact .phase-line-completed {
            top: 0.9rem;
            height: 2px;
        }
        .phase-timeline--compact .phase-dot { 
            width: 14px; 
            height: 14px; 
            border-width: 2px; 
        }
        .phase-timeline--compact .phase-label { 
            font-size: 0.65rem; 
        }
        .phase-note { 
            font-size: 0.75rem; 
            color: #4B5563; 
            margin-top: 0.5rem; 
            min-height: 1rem; 
        }
        /* Variante para modal: rótulos acima dos círculos e linha ajustada */
        .phase-timeline--modal .phase-line { top: 2.25rem; }
        .phase-label--top { margin-bottom: 0.5rem; margin-top: 0; }
        .phase-timeline--modal .phase-items { align-items: center; }
        .phase-arrow-row { text-align: center; font-size: 0.85rem; color: #374151; margin-bottom: 0.5rem; }

        /* Grade fixa para cards de informação no modal */
        .modal-info-grid { display: grid; gap: 1rem; }
        @media (min-width: 1280px) { /* xl */
            .modal-info-grid {
                grid-template-columns: 2fr 1.5fr 1.5fr;
                grid-auto-rows: minmax(140px, auto);
                grid-template-areas:
                    'descricao situacao mapa'
                    'descricao deliberacao mapa'
                    'progresso  riscos      mapa';
            }
            .card--descricao { grid-area: descricao; }
            .card--situacao { grid-area: situacao; }
            .card--deliberacao { grid-area: deliberacao; }
            .card--mapa { grid-area: mapa; }
            .card--riscos { grid-area: riscos; }
            .card--progresso { grid-area: progresso; }
        }

        /* Cartões da grade com borda */
        .project-card { border: 1px solid #E5E7EB; }
        .project-card:hover { border-color: var(--primary); }
        /* Reunião: melhorar painéis e sumário */
        details.meeting-item > summary { list-style: none; cursor: pointer; }
        details.meeting-item > summary::-webkit-details-marker { display: none; }
        details.meeting-item[open] { border-color: var(--primary-light); }
    
/* --- Correção para eliminar rolagem horizontal --- */
body, html {
    overflow-x: hidden !important;
}

main {
    width: 100%;
    overflow-x: hidden;
}

#projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* se ajusta ao tamanho da tela */
    gap: 1.5rem;
    width: 100%;
}

.project-card {
    width: 100%;
    max-width: none;
    box-sizing: border-box;
}

/* Garante que tudo se ajuste dentro da viewport */
* {
    max-width: 100%;
}

</style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white shadow-lg flex-shrink-0 overflow-y-auto">
        <div class="p-6 border-b">
            <h1 class="text-2xl font-bold text-gray-800">Projetos PPI</h1>
            <p class="text-sm text-gray-500">Acompanhamento 2025</p>
        </div>
        <nav id="sidebar-nav" class="p-4">
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 md:p-10">
        <div id="overview-section">
        </div>
        
        <div class="mt-8">
            <h2 id="section-title" class="text-3xl font-bold text-gray-700 mb-2">Visão Geral</h2>
            <p id="section-subtitle" class="text-gray-500 mb-6">Explore os projetos de infraestrutura do Brasil.</p>
            <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6">
            </div>
        </div>
    </main>

    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-[95vw] max-w-7xl max-h-[90vh] overflow-y-auto relative transform transition-all duration-300">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <div id="modal-body" class="p-8 md:p-12">
            </div>
        </div>
    </div>

<script>
// Detecta se está rodando em um ambiente estático (ex.: GitHub Pages)
const IS_STATIC_ENV = typeof window !== 'undefined' && /github\.io$/i.test(window.location.hostname);

// --- Integração com backend para respostas da SIF-Source ---
async function fetchProjectQuestions(projectId) {
    // Em modo estático (GitHub Pages), não há backend disponível
    if (IS_STATIC_ENV) {
        return {};
    }
    // Ambiente local: chama diretamente a API Node em localhost:3001
    const url = `http://localhost:3001/api/projects/${encodeURIComponent(projectId)}/questions`;
    console.log('[questions] GET', url);
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Falha ao carregar perguntas do projeto');
    const json = await res.json();
    console.log('[questions] response for', projectId, json);
    return json;
}

function formatFieldValue(fieldValue) {
    if (!fieldValue) return null;
    if (typeof fieldValue === 'object' && 'Value' in fieldValue) {
        const v = fieldValue.Value;
        if (v == null) return null;
        if (typeof v === 'object' && 'Value' in v) return String(v.Value).trim();
        return String(v).trim();
    }
    return String(fieldValue).trim();
}

function getAnswerByCode(answers, code) {
    if (!Array.isArray(answers)) return null;
    const item = answers.find(a => a.cod_source === String(code));
    if (!item) return null;
    return {
        raw: item,
        text: formatFieldValue(item.answer)
    };
}

async function enrichProjectWithQuestions(project) {
    try {
        project.details = project.details || {};

        // Map the API responses to the project details
        const mapApiData = (data) => {
            if (!data) return null;
            
            // If it's already in the correct format, return as is
            if (data.status || data.dataInicio || data.dataFim || data.dataPublicacao) {
                return data;
            }

            // Handle case where data is an array of answers
            const answers = Array.isArray(data) ? data : (data.answers || []);
            
            // Find the answer with the most recent update
            const latestAnswer = answers.reduce((latest, current) => {
                if (!latest || new Date(current.updatedAt || 0) > new Date(latest.updatedAt || 0)) {
                    return current;
                }
                return latest;
            }, null);

            if (!latestAnswer) return null;

            // Map the answer to our standard format
            return {
                status: latestAnswer.answer || latestAnswer.status,
                dataInicio: latestAnswer.startDate || latestAnswer.dataInicio,
                dataFim: latestAnswer.endDate || latestAnswer.dataFim,
                dataPublicacao: latestAnswer.publicationDate || latestAnswer.dataPublicacao
            };
        };

        // API endpoints mapping
        const apiEndpoints = {
            'etapa': '2001216',  // data de inicio-estudos
            'etapa1': '2001217', // data de fim-estudos
            'etapa2': '2001218', // status-estudos
            'etapa3': '2001219', // data de inicio-consulta publica
            'etapa4': '2001220', // data de fim-consulta publica
            'etapa5': '2001221', // status-consulta publica
            'etapa6': '2001222', // data de inicio-controle externo
            'etapa7': '2001223', // data de fim-controle externo
            'etapa8': '2001224', // status-controle externo
            'etapa9': '2001225', // status da fase - aviso de licitação
            'etapa12': '2001227', // data de inicio - licitação
            'etapa13': '2001229', // status da fase - licitação
            'FaseStatus': '2001225' // data de publicação - aviso de licitação
        };

        // Fetch data for each endpoint
        for (const [key, questionId] of Object.entries(apiEndpoints)) {
            try {
                const response = await fetchProjectQuestions(project.id, questionId);
                project.details[key] = mapApiData(response);
                
                // Log para depuração
                console.log(`Processed ${key}:`, project.details[key]);
            } catch (error) {
                console.warn(`Error fetching data for ${key}:`, error);
                project.details[key] = null;
            }
        }

        // Preserve existing details if they exist
        const isMeaningful = (v) => {
            if (v == null) return false;
            const s = String(v).trim();
            if (!s) return false;
            return s !== 'Não informado' && s !== 'Pending';
        };

        if (isMeaningful(project.currentSituation)) {
            project.details.currentSituation = String(project.currentSituation).trim();
        }
        if (isMeaningful(project.nextSteps)) {
            project.details.deliberation = String(project.nextSteps).trim();
        }
        if (Array.isArray(project.risks) && project.risks.length) {
            project.details.risks = project.risks.slice();
        }
        if (project.rawData && Array.isArray(project.rawData.QuestionsTimeline)) {
            project.details.timeline = project.rawData.QuestionsTimeline;
        }

        // Log final para depuração
        console.log('Final project details:', project.details);
        return project;
    } catch (e) {
        console.warn('Não foi possível enriquecer o projeto com as perguntas:', e);
        return project;
    }
}
const DEFAULT_PROJECT_DATA = [
    {
        id: 'tunel-santos',
        sector: 'Portos',
        name: 'Túnel Santos-Guarujá',
        status: 'Leilão Realizado',
        statusColor: 'bg-green-500', 
        details: {
            description: "Parceria Público-Privada (PPP) entre o Governo Federal e o Estado de São Paulo para a construção e operação de um túnel submerso ligando as cidades de Santos e Guarujá.",
            currentSituation: "Leilão realizado em 05 de Setembro de 2025.",
            nextSteps: "Criação da conta para o aporte da União e consultas à SEST e ao Tesouro Nacional.",
            risks: [
                "Abertura da conta aporte pela Autoridade Portuária de Santos (APS).",
                "Questões sobre a titularidade do túnel e seus impactos no orçamento da União e nos resultados da APS."
            ],
            timeline: [
                { milestone: 'Leilão', date: '05/set/2025', status: 'completed' },
            ]
        }
    },
    {
        id: 'porto-parangua',
        sector: 'Portos',
        name: 'Porto de Paranaguá',
        status: 'Aguardando Edital',
        statusColor: 'bg-yellow-500',
        details: {
            description: "Concessão do Canal de Acesso Aquaviário por 25 anos para modernização e operação.",
            currentSituation: "Aguardando retorno do relator para publicação do edital. A Resolução CPPI já definiu as condições da desestatização.",
            nextSteps: "Publicação do edital e inclusão do projeto no Plano Nacional de Desestatização (PND).",
            risks: [
                "É necessária a publicação do Decreto de inclusão no PND antes da publicação do edital."
            ],
            timeline: [
                { milestone: 'Edital', date: 'set/2025', status: 'pending' },
                { milestone: 'Leilão', date: 'nov/25', status: 'pending' },
            ]
        }
    },
    {
        id: 'fiol-1',
        sector: 'Ferrovias',
        name: 'FIOL 1',
        status: 'Em Obras',
        statusColor: 'bg-blue-500',
        details: {
            description: "Construção da Ferrovia de Integração Oeste-Leste, Trecho 1, fundamental para o escoamento da produção de grãos e minérios.",
            currentSituation: "Obras em andamento com 75% de avanço total. Lotes 1F e 2F em execução, Lote 3F concluído, Lote 4F em execução. Início da operação previsto para 2027.",
            nextSteps: "Contratação de obras remanescentes para os lotes 2F e 4F no segundo semestre de 2025.",
            risks: [
                "Gestão dos contratos remanescentes e cumprimento dos prazos para conclusão em 2028."
            ],
            progress: 75
        }
    },
    {
        id: 'transnordestina',
        sector: 'Ferrovias',
        name: 'Transnordestina "L Invertido"',
        status: 'Em Obras',
        statusColor: 'bg-blue-500',
        details: {
            description: "Projeto de construção ferroviária para conectar o interior do Nordeste aos portos de Pecém (CE) e Suape (PE).",
            currentSituation: "Avanço físico total (Fase I + II) de 62%. Vários lotes em obra, com mobilização e contratações em andamento. Previsão de operação de carga no trecho Paes Landim/PI a Acopiara/CE para o segundo semestre de 2025.",
            nextSteps: "Contratação dos lotes 9 e 10 até setembro de 2025. Liberação de recursos do FDNE e BNDES.",
            risks: [
                "Coordenação da contratação e execução de múltiplos lotes simultaneamente.",
                "Dependência da liberação de financiamentos para avanço das obras."
            ],
            progress: 62
        }
    },
    {
        id: 'br-040-cristais',
        sector: 'Rodovias',
        name: 'BR-040/GO/MG (Rota dos Cristais)',
        status: 'Contrato Assinado',
        statusColor: 'bg-green-500',
        details: {
            description: "Concessão do trecho rodoviário entre Belo Horizonte/MG e Cristalina/GO.",
            currentSituation: "Leilão realizado em 26/09/2024. O vencedor foi a Vinci Highways com um desconto de 14,32%. Contrato assinado em 19/12/2024.",
            nextSteps: "Início das operações e plano de investimentos pela concessionária.",
            risks: [],
            timeline: [
                { milestone: 'Leilão', date: '26/09/2024', status: 'completed' },
                { milestone: 'Contrato', date: '19/12/2024', status: 'completed' },
            ]
        }
    },
    {
        id: 'br-381-mg',
        sector: 'Rodovias',
        name: 'BR-381/MG',
        status: 'Contrato Assinado',
        statusColor: 'bg-green-500',
        details: {
            description: "Concessão do trecho rodoviário entre Belo Horizonte/MG e Governador Valadares/MG.",
            currentSituation: "Leilão realizado em 29/08/2024. O vencedor foi a 4UM Investimentos com um desconto de 0,94%. Contrato assinado em 02/12/2024.",
            nextSteps: "Início dos trabalhos iniciais e investimentos previstos no contrato.",
            risks: [],
            timeline: [
                 { milestone: 'Leilão', date: '29/08/2024', status: 'completed' },
                 { milestone: 'Contrato', date: '02/12/2024', status: 'completed' },
            ]
        }
    },
    {
        id: 'leilao-transmissao-2025',
        sector: 'Energia',
        name: '1º Leilão de Transmissão de 2025',
        status: 'Em Análise no TCU',
        statusColor: 'bg-yellow-500',
        details: {
            description: "Contratação de instalações para transmissão de energia elétrica em 13 estados para expansão da rede básica.",
            currentSituation: "Minuta de Edital aprovada em 24/06/2025 e atualmente em avaliação pelo Tribunal de Contas da União (TCU).",
            nextSteps: "Aguardando manifestação do TCU (previsão para 24/09/2025) para prosseguir com a publicação do edital.",
            risks: [
                "Cumprimento do cronograma dependente da análise e aprovação do TCU."
            ],
            timeline: [
                { milestone: 'Análise TCU', date: '24/09/2025 (Prev.)', status: 'pending' },
                { milestone: 'Leilão', date: '31/10/2025 (Prev.)', status: 'pending' },
            ]
        }
    },
     {
        id: 'oleo-gas-opc5',
        sector: 'Óleo e Gás',
        name: '5º Ciclo da Oferta Permanente (Concessão)',
        status: 'Leilão Realizado',
        statusColor: 'bg-green-500',
        details: {
            description: "Oferta de blocos exploratórios de petróleo e gás sob o regime de concessão.",
            currentSituation: "Leilão realizado em 17/06/2025, com arrecadação recorde de R$ 989 milhões em bônus e previsão de R$ 1,45 bilhão em investimentos. Foram arrematados 34 blocos por 9 empresas.",
            nextSteps: "Adjudicação e homologação da licitação em 01/09/2025, com assinatura dos contratos prevista para 28/11/2025.",
            risks: [],
            timeline: [
                { milestone: 'Leilão', date: '17/06/2025', status: 'completed' },
                { milestone: 'Homologação', date: '01/09/2025', status: 'pending' },
                { milestone: 'Contratos', date: '28/11/2025', status: 'pending' },
            ]
        }
    },
    {
        id: 'hidrovia-paraguai',
        sector: 'Hidrovias',
        name: 'Hidrovia do Paraguai',
        status: 'Em Análise',
        statusColor: 'bg-yellow-500',
        details: {
            description: "Concessão da hidrovia para melhorias na navegação e escoamento de produção.",
            currentSituation: "Projeto no MPOR para envio ao TCU. Previsão de leilão para 2026.",
            nextSteps: "Análise pelo TCU e revisão pós-TCU para publicação do edital.",
            risks: [
                "Necessidade de qualificação no PPI com MMA/Ibama.",
                "Mudanças estruturais na modelagem não originadas da Audiência Pública.",
                "Restrição de participação da principal usuária.",
                "Falta de consenso sobre quem será o Poder Concedente."
            ],
            timeline: [
                 { milestone: 'Análise TCU', date: '2025', status: 'pending' },
                 { milestone: 'Leilão', date: '2026 (Prev.)', status: 'pending' },
            ]
        }
    }
];

// Função para carregar e processar o arquivo de descrições
async function loadProjectDescriptions() {
    try {
        const response = await fetch('descricoes');
        if (!response.ok) {
            console.warn('Não foi possível carregar o arquivo de descrições');
            return new Map();
        }
        
        const projects = await response.json();
        const projectsMap = new Map();
        
        projects.forEach(project => {
            if (project.rawData?.GPSCoordinates?.length > 0) {
                const coords = project.rawData.GPSCoordinates[0].location;
                if (coords && coords.x && coords.y) {
                    projectsMap.set(project.sourceId, {
                        lat: parseFloat(coords.y),
                        lng: parseFloat(coords.x),
                        mapUrl: `https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(coords.x)-0.1},${parseFloat(coords.y)-0.1},${parseFloat(coords.x)+0.1},${parseFloat(coords.y)+0.1}&layer=mapnik&marker=${parseFloat(coords.y)},${parseFloat(coords.x)}`
                    });
                    console.log(`Coordenadas para ${project.name || project.sourceId}:`, coords);
                }
            }
        });
        
        console.log('Dos projetos carregados:', projectsMap.size, 'possuem coordenadas');
        return projectsMap;
    } catch (error) {
        console.error('Erro ao carregar descrições dos projetos:', error);
        return new Map();
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    const sidebarNav = document.getElementById('sidebar-nav');
    const projectsGrid = document.getElementById('projects-grid');
    const overviewSection = document.getElementById('overview-section');
    const sectionTitle = document.getElementById('section-title');
    const sectionSubtitle = document.getElementById('section-subtitle');
    const modal = document.getElementById('project-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('close-modal');

    // Supabase config (preencha via window.SUPABASE_URL / window.SUPABASE_ANON antes de carregar esta página, ou edite aqui)
    const SUPABASE_URL = window.SUPABASE_URL || '';
    const SUPABASE_ANON = window.SUPABASE_ANON || '';
    let supabaseClient = null;
    if (typeof supabase !== 'undefined' && SUPABASE_URL && SUPABASE_ANON) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    }

    let projectData = DEFAULT_PROJECT_DATA;
    let sectors = [];
    let chartInstance = null;
    let activeSector = 'Todos';
    let meetingMode = false;
    // Cache em memória para evitar reprocessar/enriquecer o mesmo projeto várias vezes
    const enrichedProjectsCache = new Map();

    function saveOverrides() {
        try {
            localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
        } catch {}
    }

    function loadOverrides() {
        try {
            const raw = localStorage.getItem('ppi_projects_overrides');
            if (raw) {
                const arr = JSON.parse(raw);
                if (Array.isArray(arr) && arr.length) {
                    projectData = arr;
                }
            }
        } catch {}
    }

    async function supaLoadProjects() {
        const { data, error } = await supabaseClient
            .from('projects')
            .select('*')
            .order('sector', { ascending: true })
            .order('name', { ascending: true });
        if (error) throw error;
        return (data || []).map(r => ({
            id: r.id,
            sector: r.sector,
            name: r.name,
            status: r.status,
            statusColor: r.status_color,
            details: {
                ...(r.details || {}),
                progress: typeof r.progress === 'number' ? r.progress : (r.details?.progress ?? 0)
            }
        }));
    }

    async function supaUpsertProjects(items) {
        const rows = items.map(p => ({
            id: p.id,
            sector: p.sector,
            name: p.name,
            status: p.status,
            status_color: p.statusColor,
            progress: typeof p.details?.progress === 'number' ? p.details.progress : null,
            details: p.details || {}
        }));
        const { error } = await supabaseClient.from('projects').upsert(rows, { onConflict: 'id' });
        if (error) throw error;
    }

    async function supaDeleteProject(id) {
        const { error } = await supabaseClient.from('projects').delete().eq('id', id);
        if (error) throw error;
    }

async function fetchProjectsFromAPI() {
    try {
        // Tenta carregar do arquivo local primeiro
        try {
            // Primeiro tenta carregar o arquivo 'projetos'
            let response = await fetch('projetos', { cache: 'no-store' });
            let data;
            
            if (response.ok) {
                try {
                    data = await response.json();
                    console.log('Dados carregados do arquivo projetos:', data);
                    
                    // Função para mapear um projeto para o formato esperado
                    const mapProject = (project) => ({
                        id: project.id || project.sourceId || Math.random().toString(36).substr(2, 9),
                        name: project.name || 'Projeto sem nome',
                        sector: project.sector || 'Outros',
                        status: project.status || 'Em andamento',
                        statusColor: getStatusColor(project.status || 'Em andamento'),
                        details: {
                            description: project.description || 'Descrição não disponível',
                            currentSituation: project.currentSituation || 'Situação atual não informada',
                            nextSteps: project.nextSteps || 'Próximos passos não definidos',
                            risks: Array.isArray(project.risks) ? project.risks : 
                                  (project.risks ? [project.risks] : ['Riscos não mapeados']),
                            // Inclui os dados brutos para referência
                            ...(project.rawData || {})
                        },
                        // Mantém os dados originais para referência
                        rawData: project.rawData || {}
                    });
                    
                    // Se os dados são um array, mapeia para o formato esperado
                    if (Array.isArray(data)) {
                        return data.map(mapProject);
                    }
                    
                    // Se for um objeto com uma propriedade que é um array, mapeia essa propriedade
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            console.log(`Mapeando array da propriedade '${key}'`);
                            return data[key].map(mapProject);
                        }
                    }
                } catch (e) {
                    console.warn('Erro ao processar o arquivo projetos, tentando próxima opção...', e);
                }
            }
            
            // Se não encontrou no formato esperado, tenta carregar projetos_descricao.json
            console.log('projetos não encontrado ou em formato inválido, tentando projetos_descricao.json...');
            response = await fetch('projetos_descricao.json', { cache: 'no-store' });
            
            // Se não encontrar, tenta carregar de projects.json
            if (!response.ok) {
                console.log('projetos_descricao.json não encontrado, tentando projects.json...');
                response = await fetch('projects.json', { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error('Erro ao buscar arquivo local de projetos');
                }
            }
            
            data = await response.json();
            console.log('Dados carregados do arquivo local:', data);
            
            // Se os dados são um array, retorna diretamente
            if (Array.isArray(data)) {
                return data;
            }
            
            // Se for um objeto com uma propriedade que é um array, retorna essa propriedade
            for (const key in data) {
                if (Array.isArray(data[key])) {
                    console.log(`Retornando array da propriedade '${key}'`);
                    return data[key];
                }
            }
            
            // Se não encontrar um array válido, lança um erro
            throw new Error('Formato de dados inválido no arquivo local');
            
        } catch (localError) {
            console.warn('Não foi possível carregar arquivo local, tentando API...', localError);
            
            // Se falhar, tenta a API (opcional, você pode remover se quiser apenas o arquivo local)
            try {
                const response = await fetch('http://localhost:3001/api/projects');
                if (!response.ok) {
                    throw new Error('Erro ao buscar projetos da API');
                }
                const data = await response.json();
                console.log('Dados carregados da API:', data);
                return data;
            } catch (apiError) {
                console.error('Erro ao buscar da API:', apiError);
                // Retorna dados de exemplo em caso de falha total
                console.log('Usando dados de exemplo devido a falha no carregamento...');
                return [
                    {
                        id: 'tunel-santos',
                        sector: 'Portos',
                        name: 'Túnel Santos-Guarujá',
                        status: 'Leilão Realizado',
                        statusColor: getStatusColor('Leilão Realizado'),
                        details: {
                            description: 'Parceria Público-Privada (PPP) entre o Governo Federal e o Estado de São Paulo para a construção e operação de um túnel submerso ligando as cidades de Santos e Guarujá.',
                            currentSituation: 'Leilão realizado em 05 de Setembro de 2025.',
                            nextSteps: 'Assinatura do contrato e início das obras.',
                            risks: ['Atraso na liberação de licenças ambientais'],
                            progress: 0
                        }
                    },
                    {
                        id: 'porto-parangua',
                        sector: 'Portos',
                        name: 'Porto de Paranaguá',
                        status: 'Aguardando Edital',
                        statusColor: getStatusColor('Aguardando Edital'),
                        details: {
                            description: 'Concessão do Canal de Acesso Aquaviário por 25 anos para modernização e operação.',
                            currentSituation: 'Aguardando retorno do relator para publicação do edital. A Resolução CPPI já definiu as condições da desestatização.',
                            nextSteps: 'Publicação do edital e realização do leilão.',
                            risks: ['Mudanças nas condições de mercado podem afetar o interesse dos investidores'],
                            progress: 0
                        }
                    },
                    {
                        id: 'fiol-1',
                        sector: 'Ferrovias',
                        name: 'FIOL 1',
                        status: 'Em Obras',
                        statusColor: getStatusColor('Em Obras'),
                        details: {
                            description: 'Construção da Ferrovia de Integração Oeste-Leste, Trecho 1, fundamental para o escoamento da produção de grãos e minérios.',
                            currentSituation: 'Obras em andamento com 75% de avanço total. Lotes 1F e 2F em execução, Lote 3F concluído, Lote 4F em execução. Início da operação previsto para 2027.',
                            nextSteps: 'Conclusão dos lotes em andamento e início dos testes operacionais.',
                            risks: ['Atraso na liberação de recursos', 'Condições climáticas desfavoráveis'],
                            progress: 75
                        }
                    }
                ];
                console.log('MAPPED FRONTEND DATA (fallback):', fallback);
                return fallback;
            }
        }
    } catch (error) {
        console.error('Erro ao buscar projetos:', error);
        return [];
    }
}

function getStatusColor(status) {
    if (!status) return 'gray';
    
    const statusLower = status.toLowerCase();
    if (statusLower.includes('concluído') || statusLower.includes('concluido') || statusLower.includes('assinado')) return 'green';
    if (statusLower.includes('andamento') || statusLower.includes('em andamento') || statusLower.includes('licitação')) return 'blue';
    if (statusLower.includes('atrasado') || statusLower.includes('parado') || statusLower.includes('suspenso')) return 'red';
    if (statusLower.includes('planejamento') || statusLower.includes('estudo')) return 'yellow';
    return 'gray';
}

    async function loadData() {
        try {
            // Tenta carregar da API primeiro
            projectData = await fetchProjectsFromAPI();
            
            // Carrega as descrições dos projetos com as coordenadas
            const projectsMap = await loadProjectDescriptions();
            
            console.log('Projetos com coordenadas encontrados:', projectsMap.size);
            
            // Atualiza os projetos com as coordenadas
            projectData = projectData.map(project => {
                // Tenta encontrar pelo sourceId (que é o id usado no arquivo descricoes)
                const projectKey = project.rawData?.Guid || project.id;
                
                if (projectsMap.has(projectKey)) {
                    const coords = projectsMap.get(projectKey);
                    console.log(`Adicionando coordenadas ao projeto ${project.name}:`, coords);
                    return {
                        ...project,
                        coordinates: {
                            lat: coords.lat,
                            lng: coords.lng
                        },
                        mapUrl: coords.mapUrl
                    };
                } else {
                    console.log(`Nenhuma coordenada encontrada para o projeto ${project.name} (${projectKey})`);
                }
                return project;
            });
            
            // Expõe para debug no console do navegador
            try { window.projectData = projectData; } catch {}
            
            // Se não retornou projetos da API, tenta carregar do Supabase ou do arquivo JSON
            if (projectData.length === 0) {
                if (supabaseClient) {
                    projectData = await supaLoadProjects();
                } else {
                    try {
                        const response = await fetch('data/projects.json', { cache: 'no-store' });
                        if (response.ok) {
                            const json = await response.json();
                            if (Array.isArray(json) && json.length > 0) {
                                projectData = json;
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao carregar projetos do arquivo:', e);
                    }
                }
                // Apply local overrides if any (apenas no modo arquivo)
                loadOverrides();
            }
        } catch (e) {
            console.error('Erro ao carregar dados:', e);
            // Fallback para os dados padrão
            projectData = [...DEFAULT_PROJECT_DATA];
        }
        
        // Remove apenas projetos de teste
        projectData = projectData.filter(project => 
            !project.name || !project.name.toLowerCase().includes('teste')
        );
        
        console.log('Total de projetos carregados:', projectData.length);
        
        sectors = ['Todos', ...new Set(projectData.map(p => p.sector))];
    }

    function renderSidebar() {
        // Mapeamento de setores para português
        const sectorTranslations = {
            // English to Portuguese translations
            'Ports': 'Portos',
            'Highways': 'Rodovias',
            'Railways': 'Ferrovias',
            'Airports': 'Aeroportos',
            'Energy': 'Energia',
            'Oil & Gas': 'Petróleo e Gás',
            'Waterways': 'Hidrovias',
            'Sanitation': 'Saneamento',
            'Social Infrastructure': 'Infraestrutura Social',
            'Other': 'Outros',
            'Water & Waste': 'Água e Resíduos',
            'Urban Services': 'Serviços Urbanos',
            'Health': 'Saúde',
            'Transport': 'Transporte',
            // Keep existing Portuguese mappings
            'Todos': 'Todos',
            'Portos': 'Portos',
            'Rodovias': 'Rodovias',
            'Ferrovias': 'Ferrovias',
            'Energia': 'Energia',
            'Óleo e Gás': 'Petróleo e Gás',
            'Hidrovias': 'Hidrovias',
            'Saúde': 'Saúde',
            'Transporte': 'Transporte'
        };

        // Filtra setores e remove 'Saúde', 'Sade', 'Health' e variações
        const filteredSectors = sectors.filter(sector => {
            if (!sector) return false;
            const lowerSector = sector.toLowerCase().trim();
            return ![
                'saúde', 'saude', 'sáude', 'saúde', 'saúde '
            ].includes(lowerSector) && 
            !lowerSector.includes('saúde') && 
            !lowerSector.includes('saude') &&
            !lowerSector.includes('health');
        });

        const sectorLinks = filteredSectors.map(sector => {
            // Usa a tradução se disponível, senão mantém o original
            const displayName = sectorTranslations[sector] || sector;
            return `
                <a href="#" data-sector="${sector}" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors ${(!meetingMode && sector === activeSector) ? 'bg-blue-100 text-blue-700 font-bold' : ''}">
                    <span class="ml-3">${displayName}</span>
                </a>
            `;
        }).join('');

        const meetingBtn = `
            <div class="mt-4 pt-4 border-t border-gray-200">
                <a href="#" data-action="meeting" class="flex items-center px-4 py-3 rounded-lg transition-colors ${meetingMode ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-700 hover:bg-gray-100'}">
                    <i class="fas fa-people-arrows mr-2"></i>
                    <span>Reunião</span>
                </a>
            </div>`;
        
        sidebarNav.innerHTML = sectorLinks + meetingBtn;
    }

    function renderKPIs() {
        const totalProjects = projectData.length;
        const projectsByStatus = projectData.reduce((acc, p) => {
            const status = p.status.toLowerCase();
            if (status.includes('assinado') || status.includes('realizado')) {
                acc.concluidos = (acc.concluidos || 0) + 1;
            } else if (status.includes('obras') || status.includes('análise')) {
                acc.andamento = (acc.andamento || 0) + 1;
            } else {
                 acc.planejamento = (acc.planejamento || 0) + 1;
            }
            return acc;
        }, { concluidos: 0, andamento: 0, planejamento: 0 });

        return `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="bg-blue-100 p-4 rounded-full mr-4"><i class="fas fa-tasks text-blue-500 fa-2x"></i></div>
                    <div>
                        <p class="text-3xl font-bold">${totalProjects}</p>
                        <p class="text-gray-500">Projetos Totais</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="bg-green-100 p-4 rounded-full mr-4"><i class="fas fa-check-circle text-green-500 fa-2x"></i></div>
                    <div>
                        <p class="text-3xl font-bold">${projectsByStatus.concluidos}</p>
                        <p class="text-gray-500">Leilões/Contratos Feitos</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="bg-yellow-100 p-4 rounded-full mr-4"><i class="fas fa-cogs text-yellow-500 fa-2x"></i></div>
                    <div>
                        <p class="text-3xl font-bold">${projectsByStatus.andamento}</p>
                        <p class="text-gray-500">Em Andamento/Análise</p>
                    </div>
                </div>
            </div>
        `;
    }

    function renderOverviewChart() {
        const sectorCounts = projectData.reduce((acc, p) => {
            acc[p.sector] = (acc[p.sector] || 0) + 1;
            return acc;
        }, {});

        overviewSection.innerHTML = `
            ${renderKPIs()}
            <div class="bg-white p-6 rounded-xl shadow-md">
                 <h3 class="text-xl font-bold mb-4">Projetos por Setor</h3>
                 <div class="chart-container">
                    <canvas id="overviewChart"></canvas>
                </div>
            </div>`;
        
        const ctx = document.getElementById('overviewChart').getContext('2d');
        if(chartInstance) {
            chartInstance.destroy();
        }
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(sectorCounts),
                datasets: [{
                    label: 'Nº de Projetos',
                    data: Object.values(sectorCounts),
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-light').trim() || '#3E5FA4',
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2E4E8C',
                    borderWidth: 1,
                    borderRadius: 5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e5e7eb'
                        }
                    },
                     x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const chartElement = elements[0];
                        const sector = chartInstance.data.labels[chartElement.index];
                        updateView(sector);
                    }
                }
            }
        });
    }

    function renderProjects(sector = 'Todos') {
        const filteredProjects = sector === 'Todos' ? projectData : projectData.filter(p => p.sector === sector);
        
        projectsGrid.innerHTML = filteredProjects.map(project => {
            // Get stage status from project details
            const etapas = [
                { id: 'etapa2', label: 'Estudos' },
                { id: 'etapa5', label: 'CP' },
                { id: 'etapa9', label: 'Edital' },
                { id: 'etapa13', label: 'Licitação' }
            ];

            const etapasHtml = etapas.map(etapa => {
                const isCompleted = project.details?.[etapa.id]?.status === 'Completed';
                return `
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full ${isCompleted ? 'bg-green-500' : 'bg-gray-300'}"></div>
                        <span class="text-xs text-gray-600">${etapa.label}</span>
                    </div>
                `;
            }).join('');

            return `
                <div data-id="${project.id}" class="project-card bg-white rounded-xl shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between">
                    <div>
                        <p class="text-sm text-gray-500">${project.sector}</p>
                        <h3 class="text-lg font-bold mt-1 text-gray-800">${project.name}</h3>
                    </div>
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center">
                            <span class="status-dot ${project.statusColor} mr-2"></span>
                            <span class="text-sm font-medium text-gray-600">${project.status}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${etapasHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Modo de Gerenciamento de Projetos (Visão em Lista)
    function renderMeetingView() {
        overviewSection.classList.add('hidden');
        sectionTitle.textContent = 'Gerenciamento de Projetos';
        sectionSubtitle.textContent = 'Visualize e edite os projetos de forma organizada';

        const sectorOptions = sectors.filter(s => s !== 'Todos')
            .map(s => `<option value="${s}" ${s===activeSector?'selected':''}>${s}</option>`).join('');
        const filtered = activeSector === 'Todos' ? projectData : projectData.filter(p => p.sector === activeSector);

        // Linhas da tabela
        const tableRows = filtered.map(p => {
            const progress = typeof p.details?.progress === 'number' ? p.details.progress : 0;
            return `
                <tr class="hover:bg-gray-50 h-16" data-project-id="${p.id}">
                    <td class="px-6 py-4 align-middle">
                        <div class="text-sm font-medium text-gray-900">${p.name || 'Sem nome'}</div>
                        <div class="text-xs text-gray-500 line-clamp-2">
                            ${p.details?.description || 'Sem descrição'}
                        </div>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <div class="text-sm text-gray-900">${p.sector || 'Não informado'}</div>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${p.statusColor || 'bg-gray-400'} text-white">
                            ${p.status || 'Sem status'}
                        </span>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <span class="text-xs text-gray-500">${progress}% concluído</span>
                    </td>
                    <td class="px-6 py-4 align-middle text-right">
                        <div class="flex justify-end space-x-2">
                            <button class="edit-btn p-1 text-blue-600 hover:text-blue-800" data-id="${p.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn p-1 text-red-600 hover:text-red-800" data-id="${p.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        }).join('');

        // Renderiza a tabela ou mensagem de nenhum resultado
        projectsGrid.innerHTML = `
            <div class="flex flex-col h-full w-full bg-white">
                <div class="py-4 px-6 border-b">
                    <h2 class="text-2xl font-semibold text-gray-800">Projetos</h2>
                    <p class="text-sm text-gray-500">Lista de projetos cadastrados</p>
                </div>
                
                <!-- Filtros e ações -->
                <div class="px-6 py-4 border-b">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                        <div class="w-full sm:w-1/2">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="meeting-search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Buscar projetos...">
                            </div>
                        </div>
                        <div class="w-full sm:w-1/2 flex justify-end space-x-2">
                            <div class="w-48">
                                <select id="sector-filter" class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="Todos">Todos os Setores</option>
                                    ${sectorOptions}
                                </select>
                            </div>
                            <button id="meeting-add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fas fa-plus mr-2"></i> Novo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de Projetos -->
                ${filtered.length > 0 ? `
                    <div class="flex-1 overflow-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 30%;">Projeto</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 20%;">Setor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 20%;">Progresso</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="flex-1 flex items-center justify-center bg-white p-8 text-center">
                        <div class="w-full max-w-md">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900">Nenhum projeto encontrado</h3>
                            <p class="mt-1 text-sm text-gray-500">Comece adicionando um novo projeto ou altere os filtros de busca.</p>
                            <div class="mt-6">
                                <button id="meeting-add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-plus mr-2"></i> Adicionar Projeto
                                </button>
                            </div>
                        </div>
                    </div>
                `}
                
                <!-- Barra de rodapé com contagem -->
                <div class="bg-white border-t border-gray-200 px-6 py-3">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">${filtered.length}</span> ${filtered.length === 1 ? 'projeto encontrado' : 'projetos encontrados'}
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">Total de projetos: ${projectData.length}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Atualiza a contagem de projetos concluídos na barra de rodapé
        const completedCount = projectData.filter(p => typeof p.details?.progress === 'number' && p.details.progress === 100).length;
        const completedElement = document.getElementById('completed-count');
        if (completedElement) {
            completedElement.textContent = completedCount;
        }

        // Manipulador do campo de busca
        const searchInput = document.getElementById('search-project');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('tbody tr[data-project-id]');
                    rows.forEach(row => {
                        const projectName = row.querySelector('td:first-child .text-sm').textContent.toLowerCase();
                        const projectSector = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                        const isVisible = projectName.includes(searchTerm) || projectSector.includes(searchTerm);
                        row.style.display = isVisible ? '' : 'none';
                    });
                }, 300);
            });
        }

        // Manipulador do seletor de setor
        document.getElementById('meeting-sector')?.addEventListener('change', (e) => {
            activeSector = e.target.value;
            renderSidebar();
            renderMeetingView();
        });

        // Botão Sair
        document.getElementById('meeting-exit')?.addEventListener('click', () => {
            meetingMode = false;
            updateView(activeSector);
        });

        // Botão Adicionar Projeto
        document.querySelectorAll('#meeting-add').forEach(btn => {
            btn.addEventListener('click', () => {
                const newProject = {
                    id: 'proj-' + Date.now(),
                    sector: activeSector === 'Todos' ? sectors[1] : activeSector,
                    name: 'Novo Projeto',
                    status: 'Em Análise',
                    statusColor: 'bg-yellow-500',
                    details: { progress: 0 }
                };
                projectData.unshift(newProject);
                renderMeetingView();
                // Rolar para o topo para ver o novo projeto
                window.scrollTo(0, 0);
            });
        });

        // Botões Editar Projeto
        document.querySelectorAll('.edit-project').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const projectId = e.currentTarget.getAttribute('data-id');
                const project = projectData.find(p => p.id === projectId);
                if (!project) return;

                // Cria o modal de edição
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Editar Projeto: ${project.name}</h3>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Projeto</label>
                                    <input type="text" id="edit-name" value="${project.name}" class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                                    <select id="edit-sector" class="w-full border border-gray-300 rounded-md p-2">
                                        ${sectors.filter(s => s !== 'Todos').map(s => 
                                            `<option value="${s}" ${s === project.sector ? 'selected' : ''}>${s}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="edit-status" class="w-full border border-gray-300 rounded-md p-2">
                                        <option value="Em Análise" ${project.status === 'Em Análise' ? 'selected' : ''}>Em Análise</option>
                                        <option value="Em Andamento" ${project.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="Concluído" ${project.status === 'Concluído' ? 'selected' : ''}>Concluído</option>
                                        <option value="Atrasado" ${project.status === 'Atrasado' ? 'selected' : ''}>Atrasado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Progresso (%)</label>
                                    <input type="number" id="edit-progress" min="0" max="100" 
                                        value="${typeof project.details?.progress === 'number' ? project.details.progress : 0}" 
                                        class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                                    <textarea id="edit-description" class="w-full border border-gray-300 rounded-md p-2 h-32">${project.details?.description || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Situação Atual</label>
                                    <textarea id="edit-currentSituation" class="w-full border border-gray-300 rounded-md p-2 h-32">${project.details?.currentSituation || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Próximos Passos</label>
                                    <textarea id="edit-nextSteps" class="w-full border border-gray-300 rounded-md p-2 h-32">${project.details?.nextSteps || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pontos de Atenção (um por linha)</label>
                                    <textarea id="edit-risks" class="w-full border border-gray-300 rounded-md p-2 h-32">${Array.isArray(project.details?.risks) ? project.details.risks.join('\n') : ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
                            <button type="button" id="cancel-edit" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="button" id="save-edit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Fechar modal ao clicar fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // Botão Cancelar
                modal.querySelector('#cancel-edit').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // Botão Salvar
                modal.querySelector('#save-edit').addEventListener('click', () => {
                    // Atualiza os dados do projeto
                    project.name = modal.querySelector('#edit-name').value;
                    project.sector = modal.querySelector('#edit-sector').value;
                    project.status = modal.querySelector('#edit-status').value;
                    project.statusColor = {
                        'Em Análise': 'bg-yellow-500',
                        'Em Andamento': 'bg-blue-500',
                        'Concluído': 'bg-green-500',
                        'Atrasado': 'bg-red-500'
                    }[project.status] || 'bg-gray-500';
                    
                    project.details = project.details || {};
                    project.details.progress = parseInt(modal.querySelector('#edit-progress').value) || 0;
                    project.details.description = modal.querySelector('#edit-description').value;
                    project.details.currentSituation = modal.querySelector('#edit-currentSituation').value;
                    project.details.nextSteps = modal.querySelector('#edit-nextSteps').value;
                    project.details.risks = modal.querySelector('#edit-risks').value.split('\n').filter(Boolean);
                    
                    // Remove o modal e atualiza a visualização
                    document.body.removeChild(modal);
                    renderMeetingView();
                });
            });
        });

        // Botão Salvar Alterações
        document.getElementById('meeting-save')?.addEventListener('click', async () => {
            try {
                if (supabaseClient) {
                    await supaUpsertProjects(projectData);
                    alert('Alterações salvas com sucesso no Supabase!');
                } else {
                    localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    alert('Alterações salvas localmente. Use Exportar JSON para baixar o arquivo.');
                }
            } catch (e) {
                alert('Erro ao salvar: ' + (e.message || e));
            }
        });

        // Botão Exportar JSON
        document.getElementById('meeting-export')?.addEventListener('click', () => {
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', `projetos-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // Botão Excluir Projeto
        document.querySelectorAll('.meeting-delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const id = e.currentTarget.getAttribute('data-id');
                const project = projectData.find(p => p.id === id);
                if (!project) return;

                if (!confirm(`Tem certeza que deseja excluir o projeto "${project.name}"? Esta ação não pode ser desfeita.`)) {
                    return;
                }

                try {
                    if (supabaseClient) {
                        await supaDeleteProject(id);
                    }
                    
                    // Remove o projeto da lista local
                    const index = projectData.findIndex(p => p.id === id);
                    if (index > -1) {
                        projectData.splice(index, 1);
                    }
                    
                    // Atualiza o localStorage se estiver usando armazenamento local
                    if (!supabaseClient) {
                        localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    }
                    
                    // Atualiza a visualização
                    renderSidebar();
                    renderMeetingView();
                    
                    alert('Projeto excluído com sucesso!');
                } catch (e) {
                    alert('Erro ao excluir o projeto: ' + (e.message || e));
                }
            });
        });
        document.getElementById('meeting-add')?.addEventListener('click', () => {
            // Determine target sector for the new project
            let targetSector = activeSector;
            if (targetSector === 'Todos') {
                targetSector = sectors.find(s => s !== 'Todos') || 'Diversos';
            }
            const newId = 'proj_' + Date.now();
            const newProject = {
                id: newId,
                sector: targetSector,
                name: 'Novo Projeto',
                status: 'Em Análise',
                statusColor: 'bg-yellow-500',
                details: {
                    description: '',
                    currentSituation: '',
                    nextSteps: '',
                    deliberation: '',
                    risks: [],
                    progress: 0,
                    mapEmbed: '',
                    mapImageUrl: ''
                }
            };
            projectData.push(newProject);
            // Ensure sectors includes the target sector (except 'Todos')
            if (!sectors.includes(targetSector)) {
                sectors.push(targetSector);
            }
            try { localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData)); } catch {}
            // If we were in 'Todos', switch the view to the target sector so it appears
            activeSector = targetSector;
            renderSidebar();
            renderMeetingView();
            // Open and focus the newly created item
            const parent = projectsGrid.querySelector(`details.meeting-item[data-id="${newId}"]`);
            if (parent) {
                parent.open = true;
                parent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
        document.getElementById('meeting-save')?.addEventListener('click', async () => {
            const fields = projectsGrid.querySelectorAll('[data-field]');
            const byId = new Map(projectData.map(p=>[p.id,p]));
            fields.forEach(el => {
                const id = el.getAttribute('data-id');
                const field = el.getAttribute('data-field');
                const proj = byId.get(id);
                if (!proj) return;
                proj.details = proj.details || {};
                if (field === 'risks') {
                    const lines = (el.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
                    proj.details.risks = lines;
                } else if (field === 'progress') {
                    const n = Number(el.value);
                    proj.details.progress = isNaN(n) ? undefined : Math.max(0, Math.min(100, n));
                } else {
                    proj.details[field] = el.value;
                }
            });
            try {
                if (supabaseClient) {
                    await supaUpsertProjects(projectData);
                    alert('Alterações salvas no Supabase!');
                } else {
                    localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    alert('Alterações salvas localmente. Use Exportar JSON para baixar o arquivo.');
                }
            } catch (e) {
                alert('Falha ao salvar: ' + (e.message || e));
            }
        });
        document.getElementById('meeting-export')?.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'projects.json';
            a.click();
            URL.revokeObjectURL(url);
        });
        // Delete per project
        projectsGrid.querySelectorAll('.meeting-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                const proj = projectData.find(p => p.id === id);
                if (!proj) return;
                if (!confirm(`Excluir o projeto "${proj.name}"? Esta ação não pode ser desfeita (no localStorage).`)) return;
                const sector = proj.sector;
                const idx = projectData.findIndex(p => p.id === id);
                if (idx >= 0) projectData.splice(idx, 1);
                try {
                    if (supabaseClient) {
                        await supaDeleteProject(id);
                    } else {
                        localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    }
                } catch (e) {
                    alert('Falha ao excluir: ' + (e.message || e));
                }
                // Update sectors list if empty
                if (!projectData.some(p => p.sector === sector)) {
                    sectors = sectors.filter(s => s === 'Todos' || s !== sector);
                    if (activeSector === sector) activeSector = 'Todos';
                }
                renderSidebar();
                renderMeetingView();
            });
        });
    }

    const PHASES = ['Estudos', 'Consulta Pública', 'TCU', 'Edital', 'Leilão', 'Assinatura do Contrato'];
    const phaseAliases = {
        'Análise TCU': 'TCU',
        'Contrato': 'Assinatura do Contrato',
        'Assinatura': 'Assinatura do Contrato',
        'Leilao': 'Leilão',
        'Consulta Publica': 'Consulta Pública',
        'EVTEA': 'Estudos',
    };

    function normalizeMilestone(name) {
        if (!name) return '';
        const key = name.normalize('NFD').replace(/\p{Diacritic}/gu, '').trim();
        const direct = PHASES.find(p => p.normalize('NFD').replace(/\p{Diacritic}/gu, '') === key);
        if (direct) return direct;
        for (const [alias, target] of Object.entries(phaseAliases)) {
            const a = alias.normalize('NFD').replace(/\p{Diacritic}/gu, '');
            if (a.toLowerCase() === key.toLowerCase()) return target;
        }
        // fuzzy contains
        if (/tcu/i.test(name)) return 'TCU';
        if (/edital/i.test(name)) return 'Edital';
        if (/leil(ã|a)o/i.test(name)) return 'Leilão';
        if (/contrat/i.test(name)) return 'Assinatura do Contrato';
        if (/consult/i.test(name)) return 'Consulta Pública';
        if (/estud|evtea/i.test(name)) return 'Estudos';
        return '';
    }

    function buildPhaseStates(details, projectStatus = '') {
        console.log('buildPhaseStates called with details:', details);
        
        // Default state: all phases not completed
        const defaultState = PHASES.map(phase => ({
            name: phase,
            completed: false,
            isCurrent: false,
            isDraft: false,
            status: 'not_started'
        }));
        
        if (!details) {
            console.log('No details provided, returning default state');
            return defaultState;
        }

        console.log('Available details keys:', Object.keys(details));
        
        // Map phase names to their corresponding status keys in the details
        const phaseToKeyMap = {
            'Estudos': 'etapa2',
            'Consulta Pública': 'etapa5',
            'TCU': 'etapa8',
            'Edital': 'etapa9',
            'Leilão': 'etapa13',
            'Assinatura do Contrato': 'etapa14'
        };

        // Helper function to normalize status values
        const normalizeStatus = (status) => {
            if (!status) return 'not_started';
            
            const statusStr = String(status).toLowerCase().trim();
            
            // Check for completed statuses
            if (['completed', 'concluído', 'concluido', 'finalizado', 'assinado', 'publicado', 
                 'realizado', 'concluida', 'concluída', 'concluido com sucesso', 'concluída com sucesso'].some(s => statusStr.includes(s))) {
                return 'completed';
            }
            
            // Check for in-progress statuses
            if (['andamento', 'progress', 'em andamento', 'em análise', 'em licitação', 
                 'em implantação', 'em revisão', 'em andamento (execução)', 'em andamento - execução', 
                 'em andamento - análise', 'em andamento - licitação'].some(s => statusStr.includes(s))) {
                return 'in_progress';
            }
            
            // Check for draft statuses
            if (statusStr.includes('rascunho') || statusStr.includes('draft') || statusStr.includes('rasc')) {
                return 'draft';
            }
            
            // Check for error statuses
            if (statusStr.includes('error') || statusStr.includes('erro') || statusStr.includes('falha')) {
                return 'error';
            }
            
            // Default to not started
            return 'not_started';
        };

        // Process each phase
        const result = PHASES.map(phase => {
            const phaseKey = phaseToKeyMap[phase];
            let phaseData = phaseKey && details[phaseKey];
            let status = 'not_started';
            
            // If phase data is not found in the direct properties, try to find it in the timeline array
            if (!phaseData && details.timeline && Array.isArray(details.timeline)) {
                const phaseInTimeline = details.timeline.find(item => 
                    item.milestone && 
                    phase.toLowerCase().includes(item.milestone.toLowerCase())
                );
                if (phaseInTimeline) {
                    phaseData = phaseInTimeline;
                    console.log(`Found phase data in timeline for: ${phase}`, phaseData);
                }
            }
            
            if (phaseData) {
                if (typeof phaseData === 'object' && phaseData !== null) {
                    // Check both status and answer fields from API response
                    status = normalizeStatus(phaseData.status || phaseData.answer || phaseData.estado || '');
                    
                    console.log(`Phase: ${phase} (${phaseKey})`, {
                        phaseData,
                        normalizedStatus: status
                    });
                } else if (typeof phaseData === 'string') {
                    status = normalizeStatus(phaseData);
                }
            } else {
                console.log(`No data found for phase: ${phase} (${phaseKey})`);
            }
            
            // Special case for Assinatura do Contrato - check project status
            if (phase === 'Assinatura do Contrato' && projectStatus) {
                console.log('Checking project status for Assinatura do Contrato:', projectStatus);
                const lowerStatus = String(projectStatus).toLowerCase();
                if (lowerStatus.includes('assinado') || lowerStatus.includes('concluído') || 
                    lowerStatus.includes('finalizado') || lowerStatus.includes('concluido') ||
                    lowerStatus.includes('concluída') || lowerStatus.includes('concluida')) {
                    status = 'completed';
                } else if (lowerStatus.includes('andamento') || lowerStatus.includes('em andamento') ||
                          lowerStatus.includes('em execução') || lowerStatus.includes('em execucao')) {
                    status = 'in_progress';
                } else if (lowerStatus.includes('rascunho') || lowerStatus.includes('draft')) {
                    status = 'draft';
                }
                console.log('Assinatura do Contrato status set to:', status);
            }
            
            return {
                name: phase,
                completed: status === 'completed',
                isCurrent: status === 'in_progress',
                isDraft: status === 'draft',
                status: status
            };
        });
        
        // Find the first phase that's not completed to mark it as current
        let foundCurrent = false;
        for (let i = 0; i < result.length; i++) {
            if (!foundCurrent && !result[i].completed) {
                // Only set as current if it's not already marked as in_progress or draft
                if (result[i].status === 'not_started') {
                    result[i].isCurrent = true;
                    console.log(`Marking phase as current (first incomplete): ${result[i].name}`);
                    foundCurrent = true;
                }
            }
            
            // Clear current status for all other phases
            if (foundCurrent && i > 0) {
                result[i].isCurrent = false;
            }
        }
        
        console.log('Final phase states:', JSON.stringify(result, null, 2));
        return result;
    }

    async function renderProjectDetails(projectId) {
        const project = projectData.find(p => p.id === projectId);
        if (!project) return;

        const modalBody = document.getElementById('modal-body');

        // Abre o modal imediatamente com os dados já disponíveis
        modal.classList.remove('hidden');
        modal.classList.add('flex', 'modal-enter');
        modalContent.classList.remove('modal-leave');

        // Usa a versão atual do projeto (sem esperar perguntas) para renderizar rápido
        const baseProject = enrichedProjectsCache.get(project.id) || project;
        const details = baseProject.details || {};
        const phaseStates = buildPhaseStates(details, project.status || '');
        
        // Encontra o índice da última etapa concluída
        const lastCompletedIndex = phaseStates.findIndex(p => !p.completed) - 1;
        const progressWidth = lastCompletedIndex >= 0 
            ? `${(lastCompletedIndex / (PHASES.length - 1)) * 100}%` 
            : '0%';
            
        // Debug information
        console.log('Phase states:', phaseStates);
        console.log('Progress width:', progressWidth);
        
        // Add test element to verify colors
        const testElement = document.createElement('div');
        testElement.style.cssText = 'position:fixed;top:10px;right:10px;background:#10B981;width:20px;height:20px;border-radius:50%;z-index:9999;';
        document.body.appendChild(testElement);
        
        const timelineHTML = `
            <div class="phase-timeline phase-timeline--compact">
                <div class="phase-line"></div>
                <div class="phase-line-completed" style="width: ${progressWidth}"></div>
                <div class="phase-items">
                    ${phaseStates.map((p, idx) => {
                        const isCurrent = p.isCurrent;
                        const isCompleted = p.completed;
                        const dotClass = isCurrent ? 'current' : (isCompleted ? 'completed' : '');
                        const labelClass = isCurrent ? 'current' : (isCompleted ? 'completed' : '');
                        
                        return `
                            <div class="phase-item">
                                <div class="phase-dot ${dotClass}"></div>
                                <div class="phase-label ${labelClass}">${p.name}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            <style>
                .phase-timeline {
                    position: relative;
                    margin: 2rem 0;
                    padding: 0 1rem;
                }
                .phase-timeline--compact {
                    margin: 1rem 0;
                }
                .phase-line {
                    position: absolute;
                    top: 16px;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background-color: #e5e7eb;
                    border-radius: 2px;
                }
                .phase-line-completed {
                    position: absolute;
                    top: 16px;
                    left: 0;
                    height: 4px;
                    background-color: #10B981;
                    border-radius: 2px;
                    transition: width 0.3s ease;
                }
                .phase-items {
                    display: flex;
                    justify-content: space-between;
                    position: relative;
                    z-index: 1;
                }
                .phase-item {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    position: relative;
                    min-width: 100px;
                }
                .phase-dot {
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background-color: #e5e7eb;
                    border: 3px solid white;
                    position: relative;
                    z-index: 2;
                    transition: all 0.3s ease;
                }
                .phase-dot.completed {
                    background-color: #10B981 !important;
                    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
                }
                .phase-dot.current {
                    background-color: #3B82F6 !important;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
                    transform: scale(1.2);
                }
                .phase-label {
                    margin-top: 0.5rem;
                    font-size: 0.75rem;
                    text-align: center;
                    color: #6B7280;
                    font-weight: 500;
                    transition: color 0.3s ease;
                }
                .phase-label.completed {
                    color: #10B981;
                    font-weight: 600;
                }
                .phase-label.current {
                    color: #3B82F6;
                    font-weight: 700;
                }
                @media (max-width: 768px) {
                    .phase-item {
                        min-width: 60px;
                    }
                    .phase-label {
                        font-size: 0.65rem;
                    }
                }
                @media (max-width: 480px) {
                    .phase-item {
                        min-width: 40px;
                    }
                    .phase-label {
                        font-size: 0.6rem;
                        white-space: nowrap;
                        transform: rotate(-45deg);
                        transform-origin: top left;
                        position: absolute;
                        bottom: -30px;
                        left: 50%;
                        margin-left: -10px;
                        width: 80px;
                        text-align: left;
                    }
                }
            </style>
        `;

        const mapHtml = project.coordinates ? `
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Localização</h3>
                <div class="h-64 w-full rounded-lg overflow-hidden border border-gray-200">
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        src="${project.mapUrl}">
                    </iframe>
                </div>
                <p class="text-sm text-gray-500 mt-2">Coordenadas: ${project.coordinates.lat.toFixed(4)}, ${project.coordinates.lng.toFixed(4)}</p>
            </div>
        ` : '';

        // Adiciona o HTML ao modal
        modalBody.innerHTML = `
            <div class="space-y-6">
                <!-- Cabeçalho do Projeto -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500">${project.sector}</p>
                            <h2 class="text-2xl font-bold text-gray-900 mt-1">${project.name}</h2>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${project.statusColor === 'green' ? 'bg-green-100 text-green-800' : project.statusColor === 'red' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${project.status}
                        </span>
                    </div>
                    
                    <!-- Seção de Detalhes -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Coluna 1: Descrição -->
                        <div class="md:col-span-2 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Descrição</h3>
                                <p class="text-gray-700">${project.details?.description || 'Descrição não disponível'}</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Situação Atual</h3>
                                    <p class="text-gray-700">${project.details?.currentSituation || 'Informação não disponível'}</p>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Próximos Passos</h3>
                                    <p class="text-gray-700">${project.details?.nextSteps || 'Informação não disponível'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Pontos de Atenção</h3>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    ${Array.isArray(project.details?.risks) && project.details.risks.length > 0 
                                        ? project.details.risks.map(risk => `<li>${risk}</li>`).join('')
                                        : '<li>Nenhum ponto de atenção identificado</li>'}
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Coluna 2: Mapa -->
                        <div class="space-y-4">
                            ${project.coordinates ? `
                            <div class="h-64 w-full rounded-lg overflow-hidden border border-gray-200">
                                <iframe 
                                    width="100%" 
                                    height="100%" 
                                    frameborder="0" 
                                    scrolling="no" 
                                    marginheight="0" 
                                    marginwidth="0" 
                                    src="${project.mapUrl}">
                                </iframe>
                                <p class="text-sm text-gray-500 mt-2">Coordenadas: ${project.coordinates.lat.toFixed(4)}, ${project.coordinates.lng.toFixed(4)}</p>
                            </div>` : `
                            <div class="bg-gray-100 rounded-lg h-64 flex items-center justify-center text-gray-500">
                                <div class="text-center p-6">
                                    <i class="fas fa-map-marked-alt text-4xl mb-2 text-gray-300"></i>
                                    <p>Localização não disponível</p>
                                </div>
                            </div>`}
                        </div>
                    </div>
                    
                    <!-- Linha do Tempo -->
                    <div class="mt-6">
                        ${timelineHTML}
                        <div class="phase-note mt-4 text-sm text-gray-500"></div>
                    </div>
                </div>
            </div>
        `;

        // Dispara enriquecimento em background (não bloqueia abertura do modal)
        if (!enrichedProjectsCache.has(project.id)) {
            enrichProjectWithQuestions(project).then(() => {
                enrichedProjectsCache.set(project.id, project);
            }).catch(err => {
                console.warn('Falha ao enriquecer projeto em background:', err?.message || err);
            });
        }
    }

    function hideModal() {
        modalContent.classList.add('modal-leave');
        modal.classList.add('modal-leave');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex', 'modal-enter', 'modal-leave');
        }, 300);
    }
    
    function updateView(sector) {
        activeSector = sector;
        if (meetingMode) {
            renderSidebar();
            renderMeetingView();
            return;
        }
        if(sector === 'Todos') {
            overviewSection.classList.remove('hidden');
            sectionTitle.textContent = "Visão Geral";
            sectionSubtitle.textContent = "Explore os projetos de infraestrutura do Brasil.";
        } else {
            overviewSection.classList.add('hidden');
            sectionTitle.textContent = `Setor: ${sector}`;
            const projectCount = projectData.filter(p => p.sector === sector).length;
            sectionSubtitle.textContent = `Encontrado(s) ${projectCount} projeto(s).`;
        }
        renderSidebar();
        renderProjects(sector);
    }
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });

    // Restore UI event listeners
    sidebarNav.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (!link) return;
        e.preventDefault();
        try {
            const action = link.getAttribute('data-action');
            if (action === 'meeting') {
                meetingMode = true;
                renderSidebar();
                renderMeetingView();
                return;
            }
            const sector = link.getAttribute('data-sector');
            if (sector) {
                // Leaving meeting mode when choosing a sector
                meetingMode = false;
                updateView(sector);
            }
        } catch (err) {
            console.error('Sidebar click failed:', err);
            alert('Erro ao processar o clique. Atualize a página e tente novamente.');
        }
    });

    projectsGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.project-card');
        if (card && card.dataset.id) {
            renderProjectDetails(card.dataset.id);
        }
    });

    closeModalBtn.addEventListener('click', hideModal);

    (async () => {
        // Optional loading state
        overviewSection.innerHTML = '<div class="bg-white p-6 rounded-xl shadow-md text-gray-500">Carregando dados...</div>';
        await loadData();
        renderOverviewChart();
        updateView('Todos');
    })();
});
</script>
    <script src="project_timeline.js"></script>
</body>
</html>