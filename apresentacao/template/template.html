<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Acompanhamento de Projetos - PPI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: The SPA uses a dashboard-style, single-page layout with a fixed sidebar for sector navigation (Portos, Rodovias, Ferrovias, etc.). The main content area initially displays a high-level summary with key metrics across all projects and a chart showing project distribution by sector. Clicking a sector in the sidebar or on the chart dynamically filters and displays a grid of project summary cards for that sector. Each card shows the project name and its current status (visualized with a color-coded indicator). Clicking a card opens a modal window, revealing detailed information: a comprehensive description, a visual timeline of key milestones (Estudos, Leilão, Contrato), current status, next steps, and critical "Pontos de Atenção" (risks). This drill-down architecture was chosen to manage the high information density of the report, allowing users to move from a broad overview to specific project details in an intuitive, hierarchical manner, rather than being confronted with a long, unstructured scroll of text. This promotes exploration and makes complex project tracking more digestible. -->
    <!-- Visualization & Content Choices: 
- Report Info: Overall project portfolio status. Goal: Inform. Viz/Method: KPI cards (HTML/Tailwind) and a main Bar Chart (Chart.js) showing project counts per sector. Interaction: Clicking a sector on the chart or sidebar filters the project list. Justification: Provides an immediate high-level overview and entry point for exploration.
- Report Info: List of projects within each sector. Goal: Organize/Navigate. Viz/Method: A dynamic grid of project cards (HTML/Tailwind). Each card has a color-coded status indicator. Interaction: Filtering via search bar; clicking a card reveals details. Justification: Allows users to quickly scan projects and dive into specifics.
- Report Info: Project milestones and deadlines (EVTEA, AP, TCU, Edital, Leilão). Goal: Show Change/Process. Viz/Method: A horizontal timeline component built with HTML/CSS and Unicode icons (✅, ⏳). Interaction: Static visual for clarity. Justification: Visually represents the project lifecycle more effectively than a simple text list.
- Report Info: Physical progress percentages (e.g., FIOL railway). Goal: Inform. Viz/Method: HTML/CSS progress bars. Interaction: Static display. Justification: A standard and instantly understandable way to show completion.
- Report Info: "Pontos de Atenção" (risks). Goal: Alert/Inform. Viz/Method: A styled callout box with a warning icon. Interaction: Static text. Justification: Visually separates critical risk information from general status updates.
- Report Info: Financial data (Leilão results, investments). Goal: Inform. Viz/Method: Formatted text in KPI cards within the project detail view. Justification: Clear and direct presentation for key numbers. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --primary: #2E4E8C; /* azul PPI */
            --primary-dark: #243B6B;
            --primary-light: #3E5FA4;
            --accent-green: #2E7D32;
            --accent-yellow: #F7B500;
            --accent-red: #C62828;
        }

        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: #4A4A4A;
            font-family: 'Inter', sans-serif;
        }
        /* Títulos sobre o fundo azul */
        #section-title { color: #FFFFFF; }
        #section-subtitle { color: #E5E7EB; }

        /* Harmonização dos utilitários mais usados com a paleta */
        .text-blue-500 { color: var(--primary) !important; }
        .text-blue-700 { color: var(--primary-dark) !important; }
        .bg-blue-100 { background-color: rgba(46, 78, 140, 0.12) !important; }
        .text-green-500 { color: var(--accent-green) !important; }
        .bg-green-100 { background-color: rgba(46, 125, 50, 0.12) !important; }
        .text-yellow-500 { color: var(--accent-yellow) !important; }
        .bg-yellow-100 { background-color: rgba(247, 181, 0, 0.12) !important; }

        /* Pontos de status alinhados à paleta */
        .status-dot.bg-blue-500 { background-color: var(--primary) !important; }
        .status-dot.bg-green-500 { background-color: var(--accent-green) !important; }
        .status-dot.bg-yellow-500 { background-color: var(--accent-yellow) !important; }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        /* Estilos para a tabela de projetos */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .projects-table-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .projects-table {
            min-width: 100%;
            table-layout: fixed;
        }
        
        .projects-table th,
        .projects-table td {
            vertical-align: top;
            padding: 0.75rem 1rem;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            display: -moz-box;
            -moz-line-clamp: 2;
            -moz-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 2.5em;
            line-height: 1.25em;
        }
        
        /* Estilos para a tabela de projetos */
        .projects-table-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .projects-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        
        .projects-table th,
        .projects-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .projects-table th {
            background-color: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #6b7280;
        }
        
        .projects-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .projects-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        
        .projects-table th,
        .projects-table td {
            vertical-align: middle;
            padding: 1rem 1.5rem;
        }
        
        /* Ajustes para dispositivos móveis */
        @media (max-width: 768px) {
            .projects-table th,
            .projects-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .projects-table th:first-child,
            .projects-table td:first-child {
                padding-left: 1rem;
            }
            
            .projects-table th:last-child,
            .projects-table td:last-child {
                padding-right: 1rem;
            }
        }
        
        /* Ajustes para barras de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 1.25rem;
            bottom: -1.25rem;
            width: 2px;
            background-color: #D1D5DB;
            transform: translateX(-50%);
        }
        .timeline-item:first-child::before {
             top: 1.25rem;
             bottom: unset;
             height: calc(100% - 1.25rem);
        }
         .timeline-item:last-child::before {
             display: none;
        }
        .timeline-icon {
            z-index: 10;
        }
        /* Linha do tempo por fases (Estudos -> Assinatura) */
        .phase-timeline { position: relative; padding-top: 0.5rem; }
        .phase-line { position: absolute; top: 1.25rem; left: 0.75rem; right: 0.75rem; height: 3px; background: #111827; }
        .phase-items { display: grid; grid-template-columns: repeat(6, 1fr); align-items: start; gap: 0; }
        .phase-item { text-align: center; position: relative; }
        .phase-dot { width: 22px; height: 22px; border-radius: 9999px; background: #FFFFFF; border: 3px solid #111827; margin: 0 auto; position: relative; }
        .phase-dot.completed { background: var(--accent-green); border-color: var(--accent-green); }
        .phase-label { margin-top: 0.5rem; font-size: 0.75rem; color: #4B5563; }
        .phase-meta { margin-top: 0.25rem; font-size: 0.7rem; color: #6B7280; }
        /* Variante compacta para cards da lista */
        .phase-timeline--compact .phase-line { top: 0.9rem; height: 2px; }
        .phase-timeline--compact .phase-dot { width: 14px; height: 14px; border-width: 2px; }
        .phase-timeline--compact .phase-label { font-size: 0.65rem; }
        .phase-note { font-size: 0.75rem; color: #4B5563; margin-top: 0.5rem; min-height: 1rem; }
        /* Variante para modal: rótulos acima dos círculos e linha ajustada */
        .phase-timeline--modal .phase-line { top: 2.25rem; }
        .phase-label--top { margin-bottom: 0.5rem; margin-top: 0; }
        .phase-timeline--modal .phase-items { align-items: center; }
        .phase-arrow-row { text-align: center; font-size: 0.85rem; color: #374151; margin-bottom: 0.5rem; }

        /* Grade fixa para cards de informação no modal */
        .modal-info-grid { display: grid; gap: 1rem; }
        @media (min-width: 1280px) { /* xl */
            .modal-info-grid {
                grid-template-columns: 2fr 1.5fr 1.5fr;
                grid-auto-rows: minmax(140px, auto);
                grid-template-areas:
                    'descricao situacao mapa'
                    'descricao deliberacao mapa'
                    'progresso  riscos      mapa';
            }
            .card--descricao { grid-area: descricao; }
            .card--situacao { grid-area: situacao; }
            .card--deliberacao { grid-area: deliberacao; }
            .card--mapa { grid-area: mapa; }
            .card--riscos { grid-area: riscos; }
            .card--progresso { grid-area: progresso; }
        }

        /* Cartões da grade com borda */
        .project-card { border: 1px solid #E5E7EB; }
        .project-card:hover { border-color: var(--primary); }
        /* Reunião: melhorar painéis e sumário */
        details.meeting-item > summary { list-style: none; cursor: pointer; }
        details.meeting-item > summary::-webkit-details-marker { display: none; }
        details.meeting-item[open] { border-color: var(--primary-light); }
    
/* --- Correção para eliminar rolagem horizontal --- */
body, html {
    overflow-x: hidden !important;
}

main {
    width: 100%;
    overflow-x: hidden;
}

#projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* se ajusta ao tamanho da tela */
    gap: 1.5rem;
    width: 100%;
}

.project-card {
    width: 100%;
    max-width: none;
    box-sizing: border-box;
}

/* Garante que tudo se ajuste dentro da viewport */
* {
    max-width: 100%;
}

</style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white shadow-lg flex-shrink-0 overflow-y-auto">
        <div class="p-6 border-b">
            <h1 class="text-2xl font-bold text-gray-800">Projetos PPI</h1>
            <p class="text-sm text-gray-500">Acompanhamento 2025</p>
        </div>
        <nav id="sidebar-nav" class="p-4">
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 md:p-10">
        <div id="overview-section">
        </div>
        
        <div class="mt-8">
            <h2 id="section-title" class="text-3xl font-bold text-gray-700 mb-2">Visão Geral</h2>
            <p id="section-subtitle" class="text-gray-500 mb-6">Explore os projetos de infraestrutura do Brasil.</p>
            <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6">
            </div>
        </div>
    </main>

    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-[95vw] max-w-7xl max-h-[90vh] overflow-y-auto relative transform transition-all duration-300">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <div id="modal-body" class="p-8 md:p-12">
            </div>
        </div>
    </div>

<script>
// Detecta se está rodando em um ambiente estático (ex.: GitHub Pages)
const IS_STATIC_ENV = typeof window !== 'undefined' && /github\.io$/i.test(window.location.hostname);

// --- Integração com backend para respostas da SIF-Source ---
async function fetchProjectQuestions(projectId) {
    // Em modo estático (GitHub Pages), não há backend disponível
    if (IS_STATIC_ENV) {
        return {};
    }
    // Ambiente local: chama diretamente a API Node em localhost:3001
    const url = `http://localhost:3001/api/projects/${encodeURIComponent(projectId)}/questions`;
    console.log('[questions] GET', url);
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Falha ao carregar perguntas do projeto');
    const json = await res.json();
    console.log('[questions] response for', projectId, json);
    return json;
}

function formatFieldValue(fieldValue) {
    if (!fieldValue) return null;
    if (typeof fieldValue === 'object' && 'Value' in fieldValue) {
        const v = fieldValue.Value;
        if (v == null) return null;
        if (typeof v === 'object' && 'Value' in v) return String(v.Value).trim();
        return String(v).trim();
    }
    return String(fieldValue).trim();
}

function getAnswerByCode(answers, code) {
    if (!Array.isArray(answers)) return null;
    const item = answers.find(a => a.cod_source === String(code));
    if (!item) return null;
    return {
        raw: item,
        text: formatFieldValue(item.answer)
    };
}

async function enrichProjectWithQuestions(project) {
    try {
        // Agora não chamamos mais a SIF-Source no frontend.
        // Apenas garantimos que os campos vindos do backend/local DB
        // estejam espelhados em project.details para o modal.

        project.details = project.details || {};

        const isMeaningful = (v) => {
            if (v == null) return false;
            const s = String(v).trim();
            if (!s) return false;
            return s !== 'Não informado' && s !== 'Pending';
        };

        // Situação atual / próximos passos / riscos já persistidos no backend
        if (isMeaningful(project.currentSituation)) {
            project.details.currentSituation = String(project.currentSituation).trim();
        }
        if (isMeaningful(project.nextSteps)) {
            // No modal usamos "deliberation" como campo de próximos passos
            project.details.deliberation = String(project.nextSteps).trim();
        }
        if (Array.isArray(project.risks) && project.risks.length) {
            project.details.risks = project.risks.slice();
        }

        // Linha do tempo, se o backend tiver salvo algo derivado das perguntas
        if (project.rawData && Array.isArray(project.rawData.QuestionsTimeline)) {
            project.details.timeline = project.rawData.QuestionsTimeline;
        }

        return project;
    } catch (e) {
        console.warn('Não foi possível sincronizar detalhes de perguntas no projeto:', e.message);
        return project;
    }
}
const DEFAULT_PROJECT_DATA = [];
document.addEventListener('DOMContentLoaded', async () => {
    const sidebarNav = document.getElementById('sidebar-nav');
    const projectsGrid = document.getElementById('projects-grid');
    const overviewSection = document.getElementById('overview-section');
    const sectionTitle = document.getElementById('section-title');
    const sectionSubtitle = document.getElementById('section-subtitle');
    const modal = document.getElementById('project-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('close-modal');

    // Supabase config (preencha via window.SUPABASE_URL / window.SUPABASE_ANON antes de carregar esta página, ou edite aqui)
    const SUPABASE_URL = window.SUPABASE_URL || '';
    const SUPABASE_ANON = window.SUPABASE_ANON || '';
    let supabaseClient = null;
    if (typeof supabase !== 'undefined' && SUPABASE_URL && SUPABASE_ANON) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    }

    let projectData = DEFAULT_PROJECT_DATA;
    let sectors = [];
    let chartInstance = null;
    let activeSector = 'Todos';
    let meetingMode = false;
    // Cache em memória para evitar reprocessar/enriquecer o mesmo projeto várias vezes
    const enrichedProjectsCache = new Map();

    function saveOverrides() {
        try {
            localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
        } catch {}
    }

    function loadOverrides() {
        try {
            const raw = localStorage.getItem('ppi_projects_overrides');
            if (raw) {
                const arr = JSON.parse(raw);
                if (Array.isArray(arr) && arr.length) {
                    projectData = arr;
                }
            }
        } catch {}
    }

    async function supaLoadProjects() {
        const { data, error } = await supabaseClient
            .from('projects')
            .select('*')
            .order('sector', { ascending: true })
            .order('name', { ascending: true });
        if (error) throw error;
        return (data || []).map(r => ({
            id: r.id,
            sector: r.sector,
            name: r.name,
            status: r.status,
            statusColor: r.status_color,
            details: {
                ...(r.details || {}),
                progress: typeof r.progress === 'number' ? r.progress : (r.details?.progress ?? 0)
            }
        }));
    }

    async function supaUpsertProjects(items) {
        const rows = items.map(p => ({
            id: p.id,
            sector: p.sector,
            name: p.name,
            status: p.status,
            status_color: p.statusColor,
            progress: typeof p.details?.progress === 'number' ? p.details.progress : null,
            details: p.details || {}
        }));
        const { error } = await supabaseClient.from('projects').upsert(rows, { onConflict: 'id' });
        if (error) throw error;
    }

    async function supaDeleteProject(id) {
        const { error } = await supabaseClient.from('projects').delete().eq('id', id);
        if (error) throw error;
    }

async function fetchProjectsFromAPI() {
    try {
        let data;

        if (IS_STATIC_ENV) {
            // GitHub Pages / ambiente estático: lê diretamente de projects.json
            const response = await fetch('projects.json', { cache: 'no-store' });
            if (!response.ok) {
                throw new Error('Erro ao buscar projects.json estático');
            }
            data = await response.json();
            console.log('RAW STATIC DATA (projects.json):', data);
        } else {
            // Ambiente local: chama diretamente a API Node em localhost:3001
            const response = await fetch('http://localhost:3001/api/projects');
            if (!response.ok) {
                throw new Error('Erro ao buscar projetos da API');
            }
            data = await response.json();
            console.log('RAW API DATA:', data);
        }

        // Se nada veio (API ou JSON), usa fallback
        if (!data || data.length === 0) {
            console.log('Nenhum projeto retornado, usando dados de exemplo...');
            data = [
                {
                    id: 'tunel-santos',
                    sector: 'Portos',
                    name: 'Túnel Santos-Guarujá',
                    status: 'Leilão Realizado',
                    description: 'Parceria Público-Privada (PPP) entre o Governo Federal e o Estado de São Paulo para a construção e operação de um túnel submerso ligando as cidades de Santos e Guarujá.',
                    currentSituation: 'Leilão realizado em 05 de Setembro de 2025.',
                    progress: 0
                },
                {
                    id: 'porto-parangua',
                    sector: 'Portos',
                    name: 'Porto de Paranaguá',
                    status: 'Aguardando Edital',
                    description: 'Concessão do Canal de Acesso Aquaviário por 25 anos para modernização e operação.',
                    currentSituation: 'Aguardando retorno do relator para publicação do edital. A Resolução CPPI já definiu as condições da desestatização.',
                    progress: 0
                },
                {
                    id: 'fiol-1',
                    sector: 'Ferrovias',
                    name: 'FIOL 1',
                    status: 'Em Obras',
                    description: 'Construção da Ferrovia de Integração Oeste-Leste, Trecho 1, fundamental para o escoamento da produção de grãos e minérios.',
                    currentSituation: 'Obras em andamento com 75% de avanço total. Lotes 1F e 2F em execução, Lote 3F concluído, Lote 4F em execução. Início da operação previsto para 2027.',
                    progress: 75
                }
            ];
        }
        
        // Mapear os dados para o formato esperado pelo frontend,
        // aproveitando todos os campos já enviados pelo backend
        const mappedData = data.map(project => {
            const normalizedRisks = project.risks
                ? (Array.isArray(project.risks) ? project.risks : [project.risks])
                : [];

            const raw = project.rawData || project.raw || {};
            const descriptionFromRaw = raw.Description || raw.description || null;
            const completionFromRaw = typeof raw.Completion === 'number' ? raw.Completion : null;

            const progressValue =
                project.progress !== undefined && project.progress !== null
                    ? project.progress
                    : (completionFromRaw !== null ? Math.round(completionFromRaw * 100) : 0);

            // Campos adicionais úteis para os cards, extraídos do rawData
            const locationsArr = Array.isArray(raw.Locations)
                ? raw.Locations
                : (raw.ManualDetails && Array.isArray(raw.ManualDetails.locations)) ? raw.ManualDetails.locations : [];
            const territoriesArr = Array.isArray(raw.Territories)
                ? raw.Territories.map(t => (t && (t.Value || t.value)) || t).filter(Boolean)
                : (raw.ManualDetails && Array.isArray(raw.ManualDetails.territories)) ? raw.ManualDetails.territories : [];
            const locationText = locationsArr.length ? locationsArr.join(', ') : null;
            const territoriesText = territoriesArr.length ? territoriesArr.join(', ') : null;

            const ownerOrg =
                raw.PMLeaderOrganisation ||
                (Array.isArray(raw.ProjectOrganizations) && raw.ProjectOrganizations.length > 0
                    ? (raw.ProjectOrganizations[0].Value || raw.ProjectOrganizations[0].value)
                    : null) ||
                (raw.ManualDetails && raw.ManualDetails.ownerOrganisation) ||
                null;

            const typeOfProjectArr = Array.isArray(raw.TypeOfProject)
                ? raw.TypeOfProject
                : (raw.ManualDetails && Array.isArray(raw.ManualDetails.typeOfProject)) ? raw.ManualDetails.typeOfProject : [];
            const projectTypeText = typeOfProjectArr.length ? typeOfProjectArr.join(', ') : null;

            const currency =
                (raw.OriginalCurrency && (raw.OriginalCurrency.Value || raw.OriginalCurrency.value)) ||
                (raw.ManualDetails && raw.ManualDetails.originalCurrency) ||
                'R$';

            const estimatedCostNumber =
                (typeof project.estimatedCost === 'number' && project.estimatedCost > 0) ? project.estimatedCost :
                (typeof raw.EstimatedCapitalCost === 'number' && raw.EstimatedCapitalCost > 0) ? raw.EstimatedCapitalCost :
                (raw.ManualDetails && typeof raw.ManualDetails.estimatedCapitalCost === 'number' && raw.ManualDetails.estimatedCapitalCost > 0) ? raw.ManualDetails.estimatedCapitalCost :
                null;

            let estimatedCostText = null;
            if (typeof estimatedCostNumber === 'number' && !Number.isNaN(estimatedCostNumber) && estimatedCostNumber > 0) {
                const millions = estimatedCostNumber / 1_000_000;
                try {
                    estimatedCostText = `${currency} ${millions.toLocaleString('pt-BR', { maximumFractionDigits: 1 })} mi`;
                } catch {
                    estimatedCostText = `${currency} ${millions.toFixed(1)} mi`;
                }
            }

            // Gera um embed de mapa (OpenStreetMap) sempre que houver coordenadas no rawData
            let mapEmbed = null;
            if (Array.isArray(raw.GPSCoordinates) && raw.GPSCoordinates.length > 0) {
                const first = raw.GPSCoordinates[0] || {};
                const loc = first.location || {};
                const lon = parseFloat(loc.x);
                const lat = parseFloat(loc.y);
                if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
                    const delta = 0.05;
                    const minLon = lon - delta;
                    const minLat = lat - delta;
                    const maxLon = lon + delta;
                    const maxLat = lat + delta;
                    const src = `https://www.openstreetmap.org/export/embed.html?bbox=${minLon},${minLat},${maxLon},${maxLat}&layer=mapnik&marker=${lat},${lon}`;
                    mapEmbed = `<iframe class="w-full h-full" src="${src}" style="border:0" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
                }
            }

            const finalName =
                project.name ||
                raw.Name ||
                'Projeto sem nome';

            const finalDescription =
                project.description ||
                descriptionFromRaw ||
                'Descrição não disponível';

            return {
                id: project.sourceId || project.id,
                sector: project.sector || raw.Sector?.Value || 'Outros',
                name: finalName,
                status: project.status || raw.CurrentProjectStatus?.Value || 'Em andamento',
                statusColor: getStatusColor(project.status || raw.CurrentProjectStatus?.Value || 'Em andamento'),
                details: {
                    description: finalDescription,
                    progress: progressValue,
                    currentSituation: project.currentSituation || 'Situação não informada',
                    // O layout atual usa "deliberation" para o card de Próximos Passos
                    deliberation: project.nextSteps || 'Próximos passos não informados',
                    nextSteps: project.nextSteps || 'Próximos passos não informados',
                    risks: normalizedRisks,
                    mapEmbed,
                    location: locationText,
                    territories: territoriesText,
                    owner: ownerOrg,
                    projectType: projectTypeText,
                    estimatedCostText
                },
                // Expor tudo que veio da API/backend para uso no frontend
                rawData: raw,
                backendProject: project
            };
        });

        console.log('MAPPED FRONTEND DATA:', mappedData);
        return mappedData;
    } catch (error) {
        console.error('Erro ao buscar projetos da API, usando dados de exemplo...', error);
        // Retornar dados de exemplo em caso de erro
        const fallback = [
            {
                id: 'tunel-santos',
                sector: 'Portos',
                name: 'Túnel Santos-Guarujá',
                status: 'Leilão Realizado',
                statusColor: getStatusColor('Leilão Realizado'),
                details: {
                    description: 'Parceria Público-Privada (PPP) entre o Governo Federal e o Estado de São Paulo para a construção e operação de um túnel submerso ligando as cidades de Santos e Guarujá.',
                    progress: 0,
                    currentSituation: 'Leilão realizado em 05 de Setembro de 2025.'
                }
            },
            {
                id: 'porto-parangua',
                sector: 'Portos',
                name: 'Porto de Paranaguá',
                status: 'Aguardando Edital',
                statusColor: getStatusColor('Aguardando Edital'),
                details: {
                    description: 'Concessão do Canal de Acesso Aquaviário por 25 anos para modernização e operação.',
                    progress: 0,
                    currentSituation: 'Aguardando retorno do relator para publicação do edital. A Resolução CPPI já definiu as condições da desestatização.'
                }
            },
            {
                id: 'fiol-1',
                sector: 'Ferrovias',
                name: 'FIOL 1',
                status: 'Em Obras',
                statusColor: getStatusColor('Em Obras'),
                details: {
                    description: 'Construção da Ferrovia de Integração Oeste-Leste, Trecho 1, fundamental para o escoamento da produção de grãos e minérios.',
                    progress: 75,
                    currentSituation: 'Obras em andamento com 75% de avanço total. Lotes 1F e 2F em execução, Lote 3F concluído, Lote 4F em execução. Início da operação previsto para 2027.'
                }
            }
        ];
        console.log('MAPPED FRONTEND DATA (fallback):', fallback);
        return fallback;
    }
}

    function getStatusColor(status) {
        if (!status) return 'gray';
        
        const statusLower = status.toLowerCase();
        if (statusLower.includes('concluído') || statusLower.includes('concluido') || statusLower.includes('assinado')) return 'green';
        if (statusLower.includes('andamento') || statusLower.includes('em andamento') || statusLower.includes('licitação')) return 'blue';
        if (statusLower.includes('atrasado') || statusLower.includes('parado') || statusLower.includes('suspenso')) return 'red';
        if (statusLower.includes('planejamento') || statusLower.includes('estudo')) return 'yellow';
        return 'gray';
    }

    async function loadData() {
        try {
            // Tenta carregar da API primeiro
            projectData = await fetchProjectsFromAPI();
        // expõe para debug no console do navegador
        try { window.projectData = projectData; } catch {}
            
            // Se não retornou projetos da API, tenta carregar do Supabase ou do arquivo JSON
            if (projectData.length === 0) {
                if (supabaseClient) {
                    projectData = await supaLoadProjects();
                } else {
                    try {
                        const response = await fetch('data/projects.json', { cache: 'no-store' });
                        if (response.ok) {
                            const json = await response.json();
                            if (Array.isArray(json) && json.length > 0) {
                                projectData = json;
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao carregar projetos do arquivo:', e);
                    }
                }
                // Apply local overrides if any (apenas no modo arquivo)
                loadOverrides();
            }
        } catch (e) {
            console.error('Erro ao carregar dados:', e);
            // Fallback para os dados padrão
            projectData = [...DEFAULT_PROJECT_DATA];
        }
        sectors = ['Todos', ...new Set(projectData.map(p => p.sector))];
    }

    function renderSidebar() {
        const sectorLinks = sectors.map(sector => `
            <a href="#" data-sector="${sector}" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors ${(!meetingMode && sector === activeSector) ? 'bg-blue-100 text-blue-700 font-bold' : ''}">
                <span class="ml-3">${sector}</span>
            </a>
        `).join('');
        const meetingBtn = `
            <div class="mt-4 pt-4 border-t border-gray-200">
                <a href="#" data-action="meeting" class="flex items-center px-4 py-3 rounded-lg transition-colors ${meetingMode ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-700 hover:bg-gray-100'}">
                    <i class="fas fa-people-arrows mr-2"></i>
                    <span>Reunião</span>
                </a>
            </div>`;
        sidebarNav.innerHTML = sectorLinks + meetingBtn;
    }

    function renderKPIs() {
        const totalProjects = projectData.length;
        const projectsByStatus = projectData.reduce((acc, p) => {
            const status = p.status.toLowerCase();
            if (status.includes('assinado') || status.includes('realizado')) {
                acc.concluidos = (acc.concluidos || 0) + 1;
            } else if (status.includes('obras') || status.includes('análise')) {
                acc.andamento = (acc.andamento || 0) + 1;
            } else {
                 acc.planejamento = (acc.planejamento || 0) + 1;
            }
            return acc;
        }, { concluidos: 0, andamento: 0, planejamento: 0 });

        return `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="bg-blue-100 p-4 rounded-full mr-4"><i class="fas fa-tasks text-blue-500 fa-2x"></i></div>
                    <div>
                        <p class="text-3xl font-bold">${totalProjects}</p>
                        <p class="text-gray-500">Projetos Totais</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="bg-green-100 p-4 rounded-full mr-4"><i class="fas fa-check-circle text-green-500 fa-2x"></i></div>
                    <div>
                        <p class="text-3xl font-bold">${projectsByStatus.concluidos}</p>
                        <p class="text-gray-500">Leilões/Contratos Feitos</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="bg-yellow-100 p-4 rounded-full mr-4"><i class="fas fa-cogs text-yellow-500 fa-2x"></i></div>
                    <div>
                        <p class="text-3xl font-bold">${projectsByStatus.andamento}</p>
                        <p class="text-gray-500">Em Andamento/Análise</p>
                    </div>
                </div>
            </div>
        `;
    }

    function renderOverviewChart() {
        const sectorCounts = projectData.reduce((acc, p) => {
            acc[p.sector] = (acc[p.sector] || 0) + 1;
            return acc;
        }, {});

        overviewSection.innerHTML = `
            ${renderKPIs()}
            <div class="bg-white p-6 rounded-xl shadow-md">
                 <h3 class="text-xl font-bold mb-4">Projetos por Setor</h3>
                 <div class="chart-container">
                    <canvas id="overviewChart"></canvas>
                </div>
            </div>`;
        
        const ctx = document.getElementById('overviewChart').getContext('2d');
        if(chartInstance) {
            chartInstance.destroy();
        }
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(sectorCounts),
                datasets: [{
                    label: 'Nº de Projetos',
                    data: Object.values(sectorCounts),
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-light').trim() || '#3E5FA4',
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2E4E8C',
                    borderWidth: 1,
                    borderRadius: 5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e5e7eb'
                        }
                    },
                     x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const chartElement = elements[0];
                        const sector = chartInstance.data.labels[chartElement.index];
                        updateView(sector);
                    }
                }
            }
        });
    }

    function renderProjects(sector = 'Todos') {
        const filteredProjects = sector === 'Todos' ? projectData : projectData.filter(p => p.sector === sector);
        
        projectsGrid.innerHTML = filteredProjects.map(project => `
            <div data-id="${project.id}" class="project-card bg-white rounded-xl shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between">
                <div>
                    <p class="text-sm text-gray-500">${project.sector}</p>
                    <h3 class="text-lg font-bold mt-1 text-gray-800">${project.name}</h3>
                </div>
                <div class="flex items-center mt-4 pt-4 border-t border-gray-200">
                    <span class="status-dot ${project.statusColor} mr-2"></span>
                    <span class="text-sm font-medium text-gray-600">${project.status}</span>
                </div>
            </div>
        `).join('');
    }

    // Modo de Gerenciamento de Projetos (Visão em Lista)
    function renderMeetingView() {
        overviewSection.classList.add('hidden');
        sectionTitle.textContent = 'Gerenciamento de Projetos';
        sectionSubtitle.textContent = 'Visualize e edite os projetos de forma organizada';

        const sectorOptions = sectors.filter(s => s !== 'Todos')
            .map(s => `<option value="${s}" ${s===activeSector?'selected':''}>${s}</option>`).join('');
        const filtered = activeSector === 'Todos' ? projectData : projectData.filter(p => p.sector === activeSector);

        // Linhas da tabela
        const tableRows = filtered.map(p => {
            const progress = typeof p.details?.progress === 'number' ? p.details.progress : 0;
            return `
                <tr class="hover:bg-gray-50 h-16" data-project-id="${p.id}">
                    <td class="px-6 py-4 align-middle">
                        <div class="text-sm font-medium text-gray-900">${p.name || 'Sem nome'}</div>
                        <div class="text-xs text-gray-500 line-clamp-2">
                            ${p.details?.description || 'Sem descrição'}
                        </div>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <div class="text-sm text-gray-900">${p.sector || 'Não informado'}</div>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${p.statusColor || 'bg-gray-400'} text-white">
                            ${p.status || 'Sem status'}
                        </span>
                    </td>
                    <td class="px-6 py-4 align-middle">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <span class="text-xs text-gray-500">${progress}% concluído</span>
                    </td>
                    <td class="px-6 py-4 align-middle text-right">
                        <div class="flex justify-end space-x-2">
                            <button class="edit-btn p-1 text-blue-600 hover:text-blue-800" data-id="${p.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn p-1 text-red-600 hover:text-red-800" data-id="${p.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        }).join('');

        // Renderiza a tabela ou mensagem de nenhum resultado
        projectsGrid.innerHTML = `
            <div class="flex flex-col h-full w-full bg-white">
                <div class="py-4 px-6 border-b">
                    <h2 class="text-2xl font-semibold text-gray-800">Projetos</h2>
                    <p class="text-sm text-gray-500">Lista de projetos cadastrados</p>
                </div>
                
                <!-- Filtros e ações -->
                <div class="px-6 py-4 border-b">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                        <div class="w-full sm:w-1/2">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="meeting-search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Buscar projetos...">
                            </div>
                        </div>
                        <div class="w-full sm:w-1/2 flex justify-end space-x-2">
                            <div class="w-48">
                                <select id="sector-filter" class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="Todos">Todos os Setores</option>
                                    ${sectorOptions}
                                </select>
                            </div>
                            <button id="meeting-add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fas fa-plus mr-2"></i> Novo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de Projetos -->
                ${filtered.length > 0 ? `
                    <div class="flex-1 overflow-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 30%;">Projeto</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 20%;">Setor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 20%;">Progresso</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="flex-1 flex items-center justify-center bg-white p-8 text-center">
                        <div class="w-full max-w-md">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900">Nenhum projeto encontrado</h3>
                            <p class="mt-1 text-sm text-gray-500">Comece adicionando um novo projeto ou altere os filtros de busca.</p>
                            <div class="mt-6">
                                <button id="meeting-add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i class="fas fa-plus mr-2"></i> Adicionar Projeto
                                </button>
                            </div>
                        </div>
                    </div>
                `}
                
                <!-- Barra de rodapé com contagem -->
                <div class="bg-white border-t border-gray-200 px-6 py-3">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">${filtered.length}</span> ${filtered.length === 1 ? 'projeto encontrado' : 'projetos encontrados'}
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">Total de projetos: ${projectData.length}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Atualiza a contagem de projetos concluídos na barra de rodapé
        const completedCount = projectData.filter(p => typeof p.details?.progress === 'number' && p.details.progress === 100).length;
        const completedElement = document.getElementById('completed-count');
        if (completedElement) {
            completedElement.textContent = completedCount;
        }

        // Manipulador do campo de busca
        const searchInput = document.getElementById('search-project');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('tbody tr[data-project-id]');
                    rows.forEach(row => {
                        const projectName = row.querySelector('td:first-child .text-sm').textContent.toLowerCase();
                        const projectSector = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                        const isVisible = projectName.includes(searchTerm) || projectSector.includes(searchTerm);
                        row.style.display = isVisible ? '' : 'none';
                    });
                }, 300);
            });
        }

        // Manipulador do seletor de setor
        document.getElementById('meeting-sector')?.addEventListener('change', (e) => {
            activeSector = e.target.value;
            renderSidebar();
            renderMeetingView();
        });

        // Botão Sair
        document.getElementById('meeting-exit')?.addEventListener('click', () => {
            meetingMode = false;
            updateView(activeSector);
        });

        // Botão Adicionar Projeto
        document.querySelectorAll('#meeting-add').forEach(btn => {
            btn.addEventListener('click', () => {
                const newProject = {
                    id: 'proj-' + Date.now(),
                    sector: activeSector === 'Todos' ? sectors[1] : activeSector,
                    name: 'Novo Projeto',
                    status: 'Em Análise',
                    statusColor: 'bg-yellow-500',
                    details: { progress: 0 }
                };
                projectData.unshift(newProject);
                renderMeetingView();
                // Rolar para o topo para ver o novo projeto
                window.scrollTo(0, 0);
            });
        });

        // Botões Editar Projeto
        document.querySelectorAll('.edit-project').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const projectId = e.currentTarget.getAttribute('data-id');
                const project = projectData.find(p => p.id === projectId);
                if (!project) return;

                // Cria o modal de edição
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Editar Projeto: ${project.name}</h3>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Projeto</label>
                                    <input type="text" id="edit-name" value="${project.name}" class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                                    <select id="edit-sector" class="w-full border border-gray-300 rounded-md p-2">
                                        ${sectors.filter(s => s !== 'Todos').map(s => 
                                            `<option value="${s}" ${s === project.sector ? 'selected' : ''}>${s}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="edit-status" class="w-full border border-gray-300 rounded-md p-2">
                                        <option value="Em Análise" ${project.status === 'Em Análise' ? 'selected' : ''}>Em Análise</option>
                                        <option value="Em Andamento" ${project.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="Concluído" ${project.status === 'Concluído' ? 'selected' : ''}>Concluído</option>
                                        <option value="Atrasado" ${project.status === 'Atrasado' ? 'selected' : ''}>Atrasado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Progresso (%)</label>
                                    <input type="number" id="edit-progress" min="0" max="100" 
                                        value="${typeof project.details?.progress === 'number' ? project.details.progress : 0}" 
                                        class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                                    <textarea id="edit-description" class="w-full border border-gray-300 rounded-md p-2 h-32">${project.details?.description || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Situação Atual</label>
                                    <textarea id="edit-currentSituation" class="w-full border border-gray-300 rounded-md p-2 h-32">${project.details?.currentSituation || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Próximos Passos</label>
                                    <textarea id="edit-nextSteps" class="w-full border border-gray-300 rounded-md p-2 h-32">${project.details?.nextSteps || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pontos de Atenção (um por linha)</label>
                                    <textarea id="edit-risks" class="w-full border border-gray-300 rounded-md p-2 h-32">${Array.isArray(project.details?.risks) ? project.details.risks.join('\n') : ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
                            <button type="button" id="cancel-edit" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="button" id="save-edit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Fechar modal ao clicar fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // Botão Cancelar
                modal.querySelector('#cancel-edit').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // Botão Salvar
                modal.querySelector('#save-edit').addEventListener('click', () => {
                    // Atualiza os dados do projeto
                    project.name = modal.querySelector('#edit-name').value;
                    project.sector = modal.querySelector('#edit-sector').value;
                    project.status = modal.querySelector('#edit-status').value;
                    project.statusColor = {
                        'Em Análise': 'bg-yellow-500',
                        'Em Andamento': 'bg-blue-500',
                        'Concluído': 'bg-green-500',
                        'Atrasado': 'bg-red-500'
                    }[project.status] || 'bg-gray-500';
                    
                    project.details = project.details || {};
                    project.details.progress = parseInt(modal.querySelector('#edit-progress').value) || 0;
                    project.details.description = modal.querySelector('#edit-description').value;
                    project.details.currentSituation = modal.querySelector('#edit-currentSituation').value;
                    project.details.nextSteps = modal.querySelector('#edit-nextSteps').value;
                    project.details.risks = modal.querySelector('#edit-risks').value.split('\n').filter(Boolean);
                    
                    // Remove o modal e atualiza a visualização
                    document.body.removeChild(modal);
                    renderMeetingView();
                });
            });
        });

        // Botão Salvar Alterações
        document.getElementById('meeting-save')?.addEventListener('click', async () => {
            try {
                if (supabaseClient) {
                    await supaUpsertProjects(projectData);
                    alert('Alterações salvas com sucesso no Supabase!');
                } else {
                    localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    alert('Alterações salvas localmente. Use Exportar JSON para baixar o arquivo.');
                }
            } catch (e) {
                alert('Erro ao salvar: ' + (e.message || e));
            }
        });

        // Botão Exportar JSON
        document.getElementById('meeting-export')?.addEventListener('click', () => {
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', `projetos-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // Botão Excluir Projeto
        document.querySelectorAll('.meeting-delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const id = e.currentTarget.getAttribute('data-id');
                const project = projectData.find(p => p.id === id);
                if (!project) return;

                if (!confirm(`Tem certeza que deseja excluir o projeto "${project.name}"? Esta ação não pode ser desfeita.`)) {
                    return;
                }

                try {
                    if (supabaseClient) {
                        await supaDeleteProject(id);
                    }
                    
                    // Remove o projeto da lista local
                    const index = projectData.findIndex(p => p.id === id);
                    if (index > -1) {
                        projectData.splice(index, 1);
                    }
                    
                    // Atualiza o localStorage se estiver usando armazenamento local
                    if (!supabaseClient) {
                        localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    }
                    
                    // Atualiza a visualização
                    renderSidebar();
                    renderMeetingView();
                    
                    alert('Projeto excluído com sucesso!');
                } catch (e) {
                    alert('Erro ao excluir o projeto: ' + (e.message || e));
                }
            });
        });
        document.getElementById('meeting-add')?.addEventListener('click', () => {
            // Determine target sector for the new project
            let targetSector = activeSector;
            if (targetSector === 'Todos') {
                targetSector = sectors.find(s => s !== 'Todos') || 'Diversos';
            }
            const newId = 'proj_' + Date.now();
            const newProject = {
                id: newId,
                sector: targetSector,
                name: 'Novo Projeto',
                status: 'Em Análise',
                statusColor: 'bg-yellow-500',
                details: {
                    description: '',
                    currentSituation: '',
                    nextSteps: '',
                    deliberation: '',
                    risks: [],
                    progress: 0,
                    mapEmbed: '',
                    mapImageUrl: ''
                }
            };
            projectData.push(newProject);
            // Ensure sectors includes the target sector (except 'Todos')
            if (!sectors.includes(targetSector)) {
                sectors.push(targetSector);
            }
            try { localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData)); } catch {}
            // If we were in 'Todos', switch the view to the target sector so it appears
            activeSector = targetSector;
            renderSidebar();
            renderMeetingView();
            // Open and focus the newly created item
            const parent = projectsGrid.querySelector(`details.meeting-item[data-id="${newId}"]`);
            if (parent) {
                parent.open = true;
                parent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
        document.getElementById('meeting-save')?.addEventListener('click', async () => {
            const fields = projectsGrid.querySelectorAll('[data-field]');
            const byId = new Map(projectData.map(p=>[p.id,p]));
            fields.forEach(el => {
                const id = el.getAttribute('data-id');
                const field = el.getAttribute('data-field');
                const proj = byId.get(id);
                if (!proj) return;
                proj.details = proj.details || {};
                if (field === 'risks') {
                    const lines = (el.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
                    proj.details.risks = lines;
                } else if (field === 'progress') {
                    const n = Number(el.value);
                    proj.details.progress = isNaN(n) ? undefined : Math.max(0, Math.min(100, n));
                } else {
                    proj.details[field] = el.value;
                }
            });
            try {
                if (supabaseClient) {
                    await supaUpsertProjects(projectData);
                    alert('Alterações salvas no Supabase!');
                } else {
                    localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    alert('Alterações salvas localmente. Use Exportar JSON para baixar o arquivo.');
                }
            } catch (e) {
                alert('Falha ao salvar: ' + (e.message || e));
            }
        });
        document.getElementById('meeting-export')?.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'projects.json';
            a.click();
            URL.revokeObjectURL(url);
        });
        // Delete per project
        projectsGrid.querySelectorAll('.meeting-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                const proj = projectData.find(p => p.id === id);
                if (!proj) return;
                if (!confirm(`Excluir o projeto "${proj.name}"? Esta ação não pode ser desfeita (no localStorage).`)) return;
                const sector = proj.sector;
                const idx = projectData.findIndex(p => p.id === id);
                if (idx >= 0) projectData.splice(idx, 1);
                try {
                    if (supabaseClient) {
                        await supaDeleteProject(id);
                    } else {
                        localStorage.setItem('ppi_projects_overrides', JSON.stringify(projectData));
                    }
                } catch (e) {
                    alert('Falha ao excluir: ' + (e.message || e));
                }
                // Update sectors list if empty
                if (!projectData.some(p => p.sector === sector)) {
                    sectors = sectors.filter(s => s === 'Todos' || s !== sector);
                    if (activeSector === sector) activeSector = 'Todos';
                }
                renderSidebar();
                renderMeetingView();
            });
        });
    }

    const PHASES = ['Estudos', 'Consulta Pública', 'TCU', 'Edital', 'Leilão', 'Assinatura do Contrato'];
    const phaseAliases = {
        'Análise TCU': 'TCU',
        'Contrato': 'Assinatura do Contrato',
        'Assinatura': 'Assinatura do Contrato',
        'Leilao': 'Leilão',
        'Consulta Publica': 'Consulta Pública',
        'EVTEA': 'Estudos',
    };

    function normalizeMilestone(name) {
        if (!name) return '';
        const key = name.normalize('NFD').replace(/\p{Diacritic}/gu, '').trim();
        const direct = PHASES.find(p => p.normalize('NFD').replace(/\p{Diacritic}/gu, '') === key);
        if (direct) return direct;
        for (const [alias, target] of Object.entries(phaseAliases)) {
            const a = alias.normalize('NFD').replace(/\p{Diacritic}/gu, '');
            if (a.toLowerCase() === key.toLowerCase()) return target;
        }
        // fuzzy contains
        if (/tcu/i.test(name)) return 'TCU';
        if (/edital/i.test(name)) return 'Edital';
        if (/leil(ã|a)o/i.test(name)) return 'Leilão';
        if (/contrat/i.test(name)) return 'Assinatura do Contrato';
        if (/consult/i.test(name)) return 'Consulta Pública';
        if (/estud|evtea/i.test(name)) return 'Estudos';
        return '';
    }

    function buildPhaseStates(details) {
        let maxCompletedIndex = -1;
        if (details && Array.isArray(details.timeline)) {
            details.timeline.forEach(it => {
                if (it && (it.status === 'completed' || it.status === 'concluded')) {
                    const norm = normalizeMilestone(it.milestone);
                    const idx = PHASES.indexOf(norm);
                    if (idx >= 0 && idx > maxCompletedIndex) maxCompletedIndex = idx;
                }
            });
        }
        return PHASES.map((phase, idx) => ({
            name: phase,
            completed: idx <= maxCompletedIndex
        }));
    }

    async function renderProjectDetails(projectId) {
        const project = projectData.find(p => p.id === projectId);
        if (!project) return;

        const modalBody = document.getElementById('modal-body');

        // Abre o modal imediatamente com os dados já disponíveis
        modal.classList.remove('hidden');
        modal.classList.add('flex', 'modal-enter');
        modalContent.classList.remove('modal-leave');

        // Usa a versão atual do projeto (sem esperar perguntas) para renderizar rápido
        const baseProject = enrichedProjectsCache.get(project.id) || project;
        const details = baseProject.details || {};
        const phaseStates = buildPhaseStates(details || {});
        const timelineHTML = `
            <div class="phase-timeline phase-timeline--compact">
                <div class="phase-line"></div>
                <div class="phase-items">
                    ${phaseStates.map(p => `
                        <div class="phase-item">
                            <div class="phase-dot ${p.completed ? 'completed' : ''}"></div>
                            <div class="phase-label">${p.name}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        modalBody.innerHTML = `
            <p class="text-sm font-semibold uppercase tracking-wider text-blue-600">${baseProject.sector}</p>
            <h2 class="text-4xl font-extrabold text-gray-800 mt-2 mb-6">${baseProject.name}</h2>
            <div class="modal-info-grid items-stretch">
                <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--descricao">
                    <h3 class="text-lg font-bold mb-2 text-gray-700">Descrição do Projeto</h3>
                    <p class="text-gray-600 leading-relaxed">${details.description || ''}</p>
                    ${details.location || details.territories || details.owner || details.projectType || details.estimatedCostText ? `
                        <div class="mt-4 text-sm text-gray-600 space-y-1">
                            ${details.location || details.territories ? `<p><span class="font-semibold">Localização:</span> ${details.location || details.territories}</p>` : ''}
                            ${details.owner ? `<p><span class="font-semibold">Responsável:</span> ${details.owner}</p>` : ''}
                            ${details.projectType ? `<p><span class="font-semibold">Tipo de Projeto:</span> ${details.projectType}</p>` : ''}
                            ${details.estimatedCostText ? `<p><span class="font-semibold">Investimento estimado:</span> ${details.estimatedCostText}</p>` : ''}
                        </div>
                    ` : ''}
                </div>

                <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--situacao">
                    <h3 class="text-lg font-bold mb-2 text-gray-700">Situação Atual</h3>
                    <p class="text-gray-600">${details.currentSituation || 'Não informado'}</p>
                    ${details.startDateOverall ? `<p class="text-xs text-gray-500 mt-1">Data de início: ${details.startDateOverall}</p>` : ''}
                </div>

                <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--deliberacao">
                    <h3 class="text-lg font-bold mb-2 text-gray-700">Próximos Passos</h3>
                    <p class="text-gray-600">${details.deliberation || 'Não informado'}</p>
                </div>

                <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--riscos">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Pontos de Atenção</h3>
                    ${details.risks && details.risks.length > 0 ? `
                        <ul class="list-disc list-inside text-gray-700 space-y-1">
                            ${details.risks.map(risk => `<li>${risk}</li>`).join('')}
                        </ul>
                    ` : `<p class=\"text-gray-600\">Não informado</p>`}
                </div>

                <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--mapa">
                    <h3 class="text-lg font-bold mb-2 text-gray-700">Mapa do Projeto</h3>
                    ${details.mapEmbed
                        ? `<div class="w-full h-48 md:h-full rounded-lg overflow-hidden border border-gray-200">${details.mapEmbed}</div>`
                        : '<div class="w-full h-48 bg-gray-100 rounded-lg border border-dashed border-gray-300 flex items-center justify-center text-gray-500">Mapa (pequena escala)</div>'
                    }
                </div>
            </div>
            <div class="mt-4 bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-lg font-bold text-gray-700 mb-2">ETAPA:</h3>
                ${timelineHTML}
                <div class="phase-note"></div>
            </div>
            <div class="mt-4 bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-lg font-bold text-gray-700 mb-2">Detalhes Técnicos da SIF-Source</h3>
                <p class="text-sm text-gray-500 mb-2">Esta seção mostra os dados completos recebidos da API da SIF-Source e da nossa API local para este projeto.</p>
                <details class="mt-2">
                    <summary class="cursor-pointer text-sm text-blue-600 hover:underline">Ver JSON bruto da SIF (rawData)</summary>
                    <pre class="mt-2 text-xs bg-gray-900 text-gray-100 rounded-lg p-3 overflow-x-auto whitespace-pre-wrap">${JSON.stringify(baseProject.rawData || {}, null, 2)}</pre>
                </details>
                <details class="mt-2">
                    <summary class="cursor-pointer text-sm text-blue-600 hover:underline">Ver JSON completo do projeto retornado pela API local</summary>
                    <pre class="mt-2 text-xs bg-gray-900 text-gray-100 rounded-lg p-3 overflow-x-auto whitespace-pre-wrap">${JSON.stringify(baseProject, null, 2)}</pre>
                </details>
            </div>
        `;

        // Dispara enriquecimento em background (não bloqueia abertura do modal)
        if (!enrichedProjectsCache.has(project.id)) {
            enrichProjectWithQuestions(project).then(() => {
                enrichedProjectsCache.set(project.id, project);
            }).catch(err => {
                console.warn('Falha ao enriquecer projeto em background:', err?.message || err);
            });
        }
    }

    function hideModal() {
        modalContent.classList.add('modal-leave');
        modal.classList.add('modal-leave');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex', 'modal-enter', 'modal-leave');
        }, 300);
    }
    
    function updateView(sector) {
        activeSector = sector;
        if (meetingMode) {
            renderSidebar();
            renderMeetingView();
            return;
        }
        if(sector === 'Todos') {
            overviewSection.classList.remove('hidden');
            sectionTitle.textContent = "Visão Geral";
            sectionSubtitle.textContent = "Explore os projetos de infraestrutura do Brasil.";
        } else {
            overviewSection.classList.add('hidden');
            sectionTitle.textContent = `Setor: ${sector}`;
            const projectCount = projectData.filter(p => p.sector === sector).length;
            sectionSubtitle.textContent = `Encontrado(s) ${projectCount} projeto(s).`;
        }
        renderSidebar();
        renderProjects(sector);
    }
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });

    // Restore UI event listeners
    sidebarNav.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (!link) return;
        e.preventDefault();
        try {
            const action = link.getAttribute('data-action');
            if (action === 'meeting') {
                meetingMode = true;
                renderSidebar();
                renderMeetingView();
                return;
            }
            const sector = link.getAttribute('data-sector');
            if (sector) {
                // Leaving meeting mode when choosing a sector
                meetingMode = false;
                updateView(sector);
            }
        } catch (err) {
            console.error('Sidebar click failed:', err);
            alert('Erro ao processar o clique. Atualize a página e tente novamente.');
        }
    });

    projectsGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.project-card');
        if (card && card.dataset.id) {
            renderProjectDetails(card.dataset.id);
        }
    });

    closeModalBtn.addEventListener('click', hideModal);

    (async () => {
        // Optional loading state
        overviewSection.innerHTML = '<div class="bg-white p-6 rounded-xl shadow-md text-gray-500">Carregando dados...</div>';
        await loadData();
        renderOverviewChart();
        updateView('Todos');
    })();
});
</script>
</body>
</html>